<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPL Block Information Station</title>
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <?!= include('css')?>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.21/b-1.6.2/b-colvis-1.6.2/b-html5-1.6.2/fh-3.1.7/datatables.min.css"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.21/b-1.6.2/b-colvis-1.6.2/b-html5-1.6.2/fh-3.1.7/datatables.min.js"></script>
    <script>
      // color constants (in HEX)
      const red = '#800000'
      const orange = '#e66000'
      const green = '#008000'
      const black = '#000000'
      // color for each test (5A-grade, 5B-grade, fail)
      const testColors = [green, orange, red]
      const aGrade = 0
      const bGrade = 1
      const fGrade = 2
      function grade_pregrade (grade) {
        if (grade === '5a') {
          return aGrade
        } else if (grade === '5b') {
          return bGrade
        } else if (grade === '8') {
          return fGrade
        } else {
          return null
        }
      }
      function grade_density (density) {
        if (density > 8.8) {
          return aGrade
        } else if (density > 8.7) {
          return bGrade
        } else {
          return fGrade
        }
      }
      function grade_dL (dL) {
        if (Math.abs(dL) <= 0.03) {
          return aGrade
        } else if (dL <= 0.05 && dL >= -0.1) {
          return bGrade
        } else {
          return fGrade
        }
      }
      function grade_otherDev (dev) {
        if (Math.abs(dev) <= 0.02) {
          return aGrade
        } else if (dev <= 0.02 && dev >= -0.04) {
          return bGrade
        } else {
          return fGrade
        }
      }
      function grade_missingRow (x) {
        if (x === 'N') {
          return aGrade
        } else {
          return fGrade
        }
      }
      function grade_thirteenHoles (x) {
        if (x === 'N') {
          return aGrade
        } else {
          return fGrade
        }
      }
      function grade_fiberPercentage (percent) {
        if (percent >= 98) {
          return aGrade
        } else if (percent >= 97) {
          return bGrade
        } else {
          return fGrade
        }
      }
      function grade_tower (percent) {
        if (percent >= 96) {
          return aGrade
        } else if (percent >= 94) {
          return bGrade
        } else {
          return fGrade
        }
      }
      function grade_scintRatio (ratio) {
        if (ratio > 0.7) {
          return aGrade
        } else {
          return fGrade
        }
      }
      
      class BlockClass {
        constructor(x) {
          //this.x = x
        }
        toString() {
          return this.x
        }
      }
    </script>
    <script>
      $(document).ready(function () {
        $('#blocksTable').DataTable( {
          paging: false,
          fixedHeader: true,
          "info": false,
          dom: 'Bfrtip',
          buttons: [
            {extend: 'colvis', text:'columns', collectionLayout: 'fixed four-column'},
            {extend: 'collection', text: 'tests', buttons: [
              {extend: 'columnToggle', text: 'basicInfo', columns: '.basicInfo'},
              {extend: 'columnToggle', text: 'hasGrade', columns: '.hasGrade'},
              {extend: 'columnToggle', text: 'tungsten', columns: '.tungsten'},
              {extend: 'columnToggle', text: 'epoxy', columns: '.epoxy'},
              {extend: 'columnToggle', text: 'density', columns: '.density'},
              {extend: 'columnToggle', text: 'tolerances', columns: '.tolerances'},
              {extend: 'columnToggle', text: 'lightTrans', columns: '.lightTrans'},
              {extend: 'columnToggle', text: 'towers', columns: '.towers'},
              {extend: 'columnToggle', text: 'scint', columns: '.scint'},
              {extend: 'columnToggle', text: 'natLight', columns: '.natLight'}]
            }
          ],
          "columns": [
            {name: "dbn", className: "basicInfo", "searchable": true, "type": "numericEmptyUnsorted", "visible": true},
            {name: "block", className: "basicInfo", "searchable": true, "type": "block", "visible": true},
            {name: "status", className: "basicInfo", "searchable": true, "type": "status", "visible": true},
            {name: "pregrade", className: "basicInfo hasGrade", "searchable": true, "type": "genericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                if (grade_pregrade(data) != null) {
                  let color = testColors[grade_pregrade(data)]
                  return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
                } else {
                  return '<span>' + data + '</span>';
                }
              } else {
                return '<span></span>'
              }
            }},
            {name: "shipment", className: "basicInfo", "searchable": true, "type": "numericEmptyUnsorted", "visible": false},
            {name: "sector", className: "basicInfo", "searchable": true, "type": "genericEmptyUnsorted", "visible": false},
            {name: "powder", className: "tungsten", "searchable": true, "type": "genericEmptyUnsorted", "visible": false},
            {name: "bucket", className: "tungsten", "searchable": true, "type": "genericEmptyUnsorted", "visible": false},
            {name: "moldSeries", className: "tungsten", "searchable": true, "type": "genericEmptyUnsorted", "visible": false},
            {name: "emptyMoldMass", className: "tungsten", "searchable": true, "type": "numericEmptyUnsorted", "visible": false},
            {name: "filledMoldMass", className: "tungsten", "searchable": true, "type": "numericEmptyUnsorted", "visible": false},
            {name: "tungstenMass", className: "tungsten", "searchable": true, "type": "numericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (data !== '0') {
                return '<span>' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "tungstenFillingDate", className: "tungsten", "searchable": true, "type": "usDateEmptyUnsorted", "visible": false},
            {name: "epoxyBatch", className: "epoxy", "searchable": true, "type": "numericEmptyUnsorted", "visible": false},
            {name: "resinMass", className: "epoxy", "searchable": true, "type": "numericEmptyUnsorted", "visible": false},
            {name: "hardenerMass", className: "epoxy", "searchable": true, "type": "numericEmptyUnsorted", "visible": false},
            {name: "epoxyFillingTime", className: "epoxy", "searchable": true, "type": "numericEmptyUnsorted", "visible": false},
            {name: "epoxyFillingDate", className: "epoxy", "searchable": true, "type": "usDateEmptyUnsorted", "visible": false},
            {name: "dL", className: "density tolerances hasGrade", "searchable": true, "type": "numericWithPlusEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_dL(data)]
                if (data > 0) {
                  return '<span style="color:' + color + '; font-weight: bold">' + '+' + data + '</span>';
                } else {
                  return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
                }
              } else {
                return '<span></span>'
              }
            }},
            {name: "dBT", className: "density tolerances hasGrade", "searchable": true, "type": "numericWithPlusEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_otherDev(data)]
                if (data > 0) {
                  return '<span style="color:' + color + '; font-weight: bold">' + '+' + data + '</span>';
                } else {
                  return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
                }
              } else {
                return '<span></span>'
              }
            }},
            {name: "dBB", className: "density tolerances hasGrade", "searchable": true, "type": "numericWithPlusEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_otherDev(data)]
                if (data > 0) {
                  return '<span style="color:' + color + '; font-weight: bold">' + '+' + data + '</span>';
                } else {
                  return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
                }
              } else {
                return '<span></span>'
              }
            }},
            {name: "dBH", className: "density tolerances hasGrade", "searchable": true, "type": "numericWithPlusEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_otherDev(data)]
                if (data > 0) {
                  return '<span style="color:' + color + '; font-weight: bold">' + '+' + data + '</span>';
                } else {
                  return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
                }
              } else {
                return '<span></span>'
              }
            }},
            {name: "dST", className: "density tolerances hasGrade", "searchable": true, "type": "numericWithPlusEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_otherDev(data)]
                if (data > 0) {
                  return '<span style="color:' + color + '; font-weight: bold">' + '+' + data + '</span>';
                } else {
                  return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
                }
              } else {
                return '<span></span>'
              }
            }},
            {name: "dSB", className: "density tolerances hasGrade", "searchable": true, "type": "numericWithPlusEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_otherDev(data)]
                if (data > 0) {
                  return '<span style="color:' + color + '; font-weight: bold">' + '+' + data + '</span>';
                } else {
                  return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
                }
              } else {
                return '<span></span>'
              }
            }},
            {name: "dSH", className: "density tolerances hasGrade", "searchable": true, "type": "numericWithPlusEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_otherDev(data)]
                if (data > 0) {
                  return '<span style="color:' + color + '; font-weight: bold">' + '+' + data + '</span>';
                } else {
                  return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
                }
              } else {
                return '<span></span>'
              }
            }},
            {name: "volume", className: "density", "searchable": true, "type": "numericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                return '<span>' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "toleranceMse", "searchable": true, "type": "numericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                return '<span>' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "mass", className: "density", "searchable": true, "type": "numericEmptyUnsorted", "visible": false},
            {name: "density", className: "density hasGrade", "searchable": true, "type": "numericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_density(data)]
                return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "densityDate", className: "density", "searchable": true, "type": "numericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                return '<span>' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "goodEnd", className: "lightTrans", "searchable": true, "type": "genericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                return '<span>' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "fiberPercentage", className: "lightTrans hasGrade", "searchable": true, "type": "numericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data) && data !== '0.00') {
                let color = testColors[grade_fiberPercentage(data)]
                return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "tower1", className: "lightTrans towers hasGrade", "searchable": true, "type": "numericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_tower(data)]
                return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "tower2", className: "lightTrans towers hasGrade", "searchable": true, "type": "numericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_tower(data)]
                return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "tower3", className: "lightTrans towers hasGrade", "searchable": true, "type": "numericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_tower(data)]
                return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "tower4", className: "lightTrans towers hasGrade", "searchable": true, "type": "numericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_tower(data)]
                return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "missingRow", className: "lightTrans hasGrade", "searchable": true, "type": "genericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_missingRow(data)]
                return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "thirteenHoles", className: "lightTrans hasGrade", "searchable": true, "type": "genericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_thirteenHoles(data)]
                return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "lightTransDate", className: "lightTrans", "searchable": true, "type": "numericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                return '<span>' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "scintillation", className: "scint", "searchable": true, "type": "numericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                return '<span>' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "scintRatio", className: "scint hasGrade", "searchable": true, "type": "numericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                let color = testColors[grade_scintRatio(data)]
                return '<span style="color:' + color + '; font-weight: bold">' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "scintDate", className: "scint", "searchable": true, "type": "numericEmptyUnsorted", "visible": false, render: function ( data, type, row ) {
              if (dataPresent(data)) {
                return '<span>' + data + '</span>';
              } else {
                return '<span></span>'
              }
            }},
            {name: "natLightDate", className: "natLight", "searchable": true, "type": "numericEmptyUnsorted", "visible": false}
          ]
        })
      })
      $.extend($.fn.dataTable.ext.type.order, {
        "numericEmptyUnsorted-asc": function (a, b) {
          a = (new DOMParser).parseFromString(a, 'text/html').documentElement.textContent
          b = (new DOMParser).parseFromString(b, 'text/html').documentElement.textContent
          if (a === b) {
            return 0
          } else if (a === '') {
            return 1
          } else if (b === '') {
            return -1
          } else if (isNaN(a)) {
            return 1
          } else if (isNaN(b)) {
            return -1
          } else {
            a = parseFloat(a)
            b = parseFloat(b)
            return ((a > b) ? 1 : ((a < b) ? -1 : 0)) 
          }
        },
        "numericEmptyUnsorted-desc": function (a, b) {
          a = (new DOMParser).parseFromString(a, 'text/html').documentElement.textContent
          b = (new DOMParser).parseFromString(b, 'text/html').documentElement.textContent
          if (a === b) {
            return 0
          } else if (a === '') {
            return 1
          } else if (b === '') {
            return -1
          } else if (isNaN(a)) {
            return -1
          } else if (isNaN(b)) {
            return 1
          } else {
            a = parseFloat(a)
            b = parseFloat(b)
            return ((a < b) ? 1 : ((a > b) ? -1 : 0)) 
          }
        },
        "genericEmptyUnsorted-asc": function (a, b) {
          a = (new DOMParser).parseFromString(a, 'text/html').documentElement.textContent
          b = (new DOMParser).parseFromString(b, 'text/html').documentElement.textContent
          if (a === b) {
            return 0
          } else if (a === '') {
            return 1
          } else if (b === '') {
            return -1
          } else {
            return ((a > b) ? 1 : ((a < b) ? -1 : 0)) 
          }
        },
        "genericEmptyUnsorted-desc": function (a, b) {
          a = (new DOMParser).parseFromString(a, 'text/html').documentElement.textContent
          b = (new DOMParser).parseFromString(b, 'text/html').documentElement.textContent
          if (a === b) {
            return 0
          } else if (a === '') {
            return 1
          } else if (b === '') {
            return -1
          } else {
            return ((a < b) ? 1 : ((a > b) ? -1 : 0)) 
          }
        },
        "usDateEmptyUnsorted-asc": function (a, b) {
          a = (new DOMParser).parseFromString(a, 'text/html').documentElement.textContent
          b = (new DOMParser).parseFromString(b, 'text/html').documentElement.textContent
          if (a === b) {
            return 0
          } else if (a === '') {
            return 1
          } else if (b === '') {
            return -1
          } else {
            a = parseInt(usDateToYYYYMMDD(a))
            b = parseInt(usDateToYYYYMMDD(b))
            return ((a > b) ? 1 : ((a < b) ? -1 : 0)) 
          }
        },
        "usDateEmptyUnsorted-desc": function (a, b) {
          a = (new DOMParser).parseFromString(a, 'text/html').documentElement.textContent
          b = (new DOMParser).parseFromString(b, 'text/html').documentElement.textContent
          if (a === b) {
            return 0
          } else if (a === '') {
            return 1
          } else if (b === '') {
            return -1
          } else {
            a = parseInt(usDateToYYYYMMDD(a))
            b = parseInt(usDateToYYYYMMDD(b))
            return ((a < b) ? 1 : ((a > b) ? -1 : 0)) 
          }
        },
        "numericWithPlusEmptyUnsorted-asc": function (a, b) {
          a = (new DOMParser).parseFromString(a, 'text/html').documentElement.textContent
          b = (new DOMParser).parseFromString(b, 'text/html').documentElement.textContent
          if (a === b) {
            return 0
          } else if (a === '') {
            return 1
          } else if (b === '') {
            return -1
          } else {
            a = parseFloatRemovePlus(a)
            b = parseFloatRemovePlus(b)
            return ((a > b) ? 1 : ((a < b) ? -1 : 0)) 
          }
        },
        "numericWithPlusEmptyUnsorted-desc": function (a, b) {
          a = (new DOMParser).parseFromString(a, 'text/html').documentElement.textContent
          b = (new DOMParser).parseFromString(b, 'text/html').documentElement.textContent
          if (a === b) {
            return 0
          } else if (a === '') {
            return 1
          } else if (b === '') {
            return -1
          } else {
            a = parseFloatRemovePlus(a)
            b = parseFloatRemovePlus(b)
            return ((a < b) ? 1 : ((a > b) ? -1 : 0)) 
          }
        },
        "block-asc": function (a, b) {
          a = (new DOMParser).parseFromString(a, 'text/html').documentElement.textContent
          b = (new DOMParser).parseFromString(b, 'text/html').documentElement.textContent
          if (a === b) {
            return 0
          } else if (a === '') {
            return 1
          } else if (b === '') {
            return -1
          } else {
            a = parseInt(a)
            b = parseInt(b)
            return ((a === 123) ? -1 : ((b === 123) ? 1 : ((a > b) ? 1 : ((a < b) ? -1 : 0))))
          }
        },
        "block-desc": function (a, b) {
          a = (new DOMParser).parseFromString(a, 'text/html').documentElement.textContent
          b = (new DOMParser).parseFromString(b, 'text/html').documentElement.textContent
          if (a === b) {
            return 0
          } else if (a === '') {
            return 1
          } else if (b === '') {
            return -1
          } else {
            a = parseInt(a)
            b = parseInt(b)
            return ((a === 123) ? 1 : ((b === 123) ? -1 : ((a < b) ? 1 : ((a > b) ? -1 : 0))))
          }
        },
        "status-asc": function (a, b) {
          a = (new DOMParser).parseFromString(a, 'text/html').documentElement.textContent
          b = (new DOMParser).parseFromString(b, 'text/html').documentElement.textContent
          if (a === b) {
            return 0
          } else if (a === '') {
            return 1
          } else if (b === '') {
            return -1
          } else {
            return ((a === '0') ? 1 : ((b === '0') ? -1 : ((a > b) ? 1 : ((a < b) ? -1 : 0))))
          }
        },
        "status-desc": function (a, b) {
          a = (new DOMParser).parseFromString(a, 'text/html').documentElement.textContent
          b = (new DOMParser).parseFromString(b, 'text/html').documentElement.textContent
          if (a === b) {
            return 0
          } else if (a === '') {
            return 1
          } else if (b === '') {
            return -1
          } else {
            return ((a === '0') ? 1 : ((b === '0') ? -1 : ((a < b) ? 1 : ((a > b) ? -1 : 0))))
          }
        }
      });
      function parseFloatRemovePlus (string) {
        if (string[0] === '+') {
          return parseFloat(string.substr(1))
        } else {
          return parseFloat(string)
        }
      }
      function usDateToYYYYMMDD (usDate) {
        function to2digits (string) {
          if (string.length < 2) {
            return '0' + string
          } else {
            return string
          }
        }
        let splitDate = usDate.split('/')
        let month = to2digits(splitDate[0])
        let day = to2digits(splitDate[1])
        let year = splitDate[2]
        return year + month + day
      }
    </script>
</head>
<body onload="getDatabaseOnLoad()" style="margin: 16px;">
  <div class="header" style="display: block; padding-bottom: 2em;">
    <img src="https://drive.google.com/uc?id=1JLX7vfDnqgYd_OrgPNtvj1sqV8n4ANpd" />
    <h1>NPL Block Information Station</h1>
  </div>
  <p id="loadingDatabase" style="display: none;">Loading Database...</p>
  <p id="currentDateAndTime" style="display: none;"></p>
  <section id="findBlockInfo" style="display: none;">
    <section style="display: inline-block; margin-left: 0em;">
      <form action="javascript:onSubmit()" style="display: inline;">
        <label>DBN: </label><input type="text" id="inputDBN">
        <button>Submit</button>
      </form>
      <button onclick="madness()">load all images</button>
      <button onclick="loadFindBlocks()">Find Blocks</button>
      <button onclick="" style="margin-left: 0; display: none;">Download as PDF</button>
    </section>
    <p id="loadingBlockData" style="display: none;">Loading Block Data...</p>
    <section id="imagesSelection" style="display: none;  margin-top: 1em;">
      <section id="allCheckboxes" style="display: none;">
        <section id="CBshow-lightTransImgSection" style="display: none;">
          <input type="checkbox" id="CBshow-lightTransImg" onclick="toggleImages('lightTransImg')">
          <label for="CBshow-lightTransImg" id="CBshow-lightTransImgLabel">Show Light Transmission Original Images</label><br>
        </section>
        <section id="CBshow-lightTransImgCroppedSection" style="display: none;">
          <input type="checkbox" id="CBshow-lightTransImgCropped" onclick="toggleImages('lightTransImgCropped')">
          <label for="CBshow-lightTransImgCropped" id="CBshow-lightTransImgCroppedLabel">Show Light Transmission Cropped Images</label><br>
        </section>
        <section id="CBshow-natLightImgSection" style="display: none;">
          <input type="checkbox" id="CBshow-natLightImg" onclick="toggleImages('natLightImg')">
          <label for="CBshow-natLightImg" id="CBshow-natLightImgLabel">Show Natural Light Images</label>
        </section>
      </section>
      <div id="loadingImages" style="display: none;">Loading Images...</div>
      <div id="noImagesFound" style="display: none;">No Images Found</div>
    </section>
    <section id="blockDetailsSection" style="display: none;">
      <h2>Block Details</h2>
      <dl class='inline-flex'>
        <dt id='dbnLabel'>DBN:</dt>
        <dd id="dbn"></dd>
        <dt id='blockLabel'>Block Design:</dt>
        <dd id="block"></dd>
        <dt id='statusLabel'>Status:</dt>
        <dd id="status"></dd>
        <dt id='pregradeLabel'>Pregrade:</dt>
        <dd id="pregrade"></dd>
        <dt id="shipmentLabel">BNL Shipment:</dt>
        <dd id="shipment"></dd>
        <dt id="sectorLabel">Sector:</dt>
        <dd id="sector"></dd>
        <dt id="commentLabel">Comment:</dt>
        <dd id="comment"></dd>
        <section style="width: 100%; padding-top: 1em;">
          <button id="showTungstenTableBtn" style="display: none;" onclick="toggleTungstenTable()">Show Tungsten Powder Information</button>
          <table class="dimension" id="tungstenTable" style="display: none; padding-top: 1em; border-collapse: collapse; fill: #333;">
            <tr>
              <th>Powder</th><th>Bucket Number</th><th>Mold Series</th><th>Empty Mold Mass (g)</th><th>Filled Mold Mass (g)</th><th>Tungsten Mass (g)</th><th>Filling Date</th>
            </tr>
            <tr>
              <td id="powder"></td><td id="bucket"></td><td id="moldSeries"></td><td id="emptyMoldMass"></td><td id="filledMoldMass"></td><td id="tungstenMass"></td><td id="tungstenFillingDate"></td>
            </tr>
          </table>
        </section>
        <section style="width: 100%; padding-top: 1em;">
          <button id="showEpoxyTableBtn" style="display: none;" onclick="toggleEpoxyTable()">Show Epoxy Information</button>
          <table class="dimension" id="epoxyTable" style="display: none; padding-top: 1em; border-collapse: collapse; fill: #333;">
            <tr>
              <th>Epoxy Batch</th><th>Resin Mass (g)</th><th>Hardener Mass (g)</th><th>Potting Notes</th><th>Epoxy Filling Time (min)</th><th style="height: inherit;">Filling Date</th>
            </tr>
            <tr>
              <td id="epoxyBatch"></td><td id="resinMass"></td><td id="hardenerMass"></td><td id="pottingNotes"></td><td id="epoxyFillingTime"></td><td id="epoxyFillingDate"></td>
            </tr>
          </table>
        </section>
      </dl>
    </section>
    <section id="blockDetailsNoInfo" style="display: none;">
      <p style="font-style: italic; font-size: 1.5em;">Unable to find any block information for this dbn</p>
    </section>
    <section id="densitySection" style="display: none;">
      <h2 id="densitySectionLabel">Density</h2>
      <dl class='inline-flex'>
        <dt id='volumeLabel'>Volume:</dt>
        <dd id="volume"></dd>
        <dt id='massLabel'>Mass:</dt>
        <dd id="mass"></dd>
        <dt id='densityLabel'>Density:</dt>
        <dd id="density" style="font-weight: bold;"></dd>
        <dt id='densityDateLabel'>Date:</dt>
        <dd id="densityDate"></dd>
      </dl>
      <button id="showTolerancesTableBtn" style="display: none;" onclick="toggleTolerancesTable()">Show Tolerances</button>
      <table class="dimension" id="tolerancesTable" style="display: none; padding-top: 1em; border-collapse: collapse; fill: #333;">
        <tr>
          <th>ΔL</th><th>ΔBT</th><th>ΔBB</th><th>ΔBH</th><th>ΔST</th><th>ΔSB</th><th>ΔSH</th>
        </tr>
        <tr>
          <td id="L" style="font-weight: bold;"></td><td id="BT" style="font-weight: bold;"></td><td id="BB" style="font-weight: bold;"></td><td id="BH" style="font-weight: bold;"></td><td id="ST" style="font-weight: bold;"></td><td id="SB" style="font-weight: bold;"></td><td id="SH" style="font-weight: bold;"></td>
        </tr>
      </table>
    </section>
    <section id="densityNoInfo" style="display: none;">
      <p style="font-style: italic; font-size: 1.5em;">Unable to find any density data for this block</p>
    </section>
    <section id="lightTransSection" style="display: none;">
      <h2 id="lightTransSectionLabel">Light Transmission</h2>
      <dl class='inline-flex'>
        <dt id='fiberPercentageLabel'>Fiber Count:</dt>
        <dd id="fiberPercentage" style="font-weight: bold;"></dd>
        <dt id='goodEndLabel'>Good End:</dt>
        <dd id="goodEnd"></dd>
        <dt id='missingRowLabel'>Missing Row:</dt>
        <dd id="missingRow" style="font-weight: bold;"></dd>
        <dt id='thirteenHolesLabel'>13 Connected Holes:</dt>
        <dd id="thirteenHoles" style="font-weight: bold;"></dd>
        <dt id='lightTransDateLabel'>Date:</dt>
        <dd id="lightTransDate"></dd>
      </dl>
      <button id="showTowerTableBtn" style="display: none; margin-bottom: 1em;" onclick="toggleTowerTable()">Show Tower Information</button>
      <table class="dimension" id="towerTable" style="display: none; margin-bottom: 1em; border-collapse: collapse; fill: #333;">
        <tr>
          <th>T1 (BL)</th><th>T2 (BR)</th><th>T3 (TL)</th><th>T3 (TR)</th>
        </tr>
        <tr>
          <td id="tower1" style="font-weight: bold;"></td><td id="tower2" style="font-weight: bold;"></td><td id="tower3" style="font-weight: bold;"></td><td id="tower4" style="font-weight: bold;"></td>
        </tr>
      </table>
      <a id="histogramWide" target="_blank" style="display: none;">Histograms (Wide)<br></a>
      <a id="histogramNarrow" target="_blank" style="display: none;;">Histograms (Narrow)</a>
      <figure class="testImg" id="lightTransImgFigW" style="display: none;">
        <img id="lightTransImgW" height="360"/>
        <figcaption>Wide End</figcaption>
      </figure>
      <figure class="testImg" id="lightTransImgFigN" style="display: none;">
        <img id="lightTransImgN" height="360"/>
        <figcaption>Narrow End</figcaption>
      </figure>
      <figure class="testImg" id="lightTransImgCroppedFigW" style="display: none;">
        <img id="lightTransImgCroppedW" height="360"/>
        <figcaption>Wide End</figcaption>
      </figure>
      <figure class="testImg" id="lightTransImgCroppedFigN" style="display: none;">
        <img id="lightTransImgCroppedN" height="360"/>
        <figcaption>Narrow End</figcaption>
      </figure>
    </section>
    <section id="lightTransNoInfo" style="display: none;">
      <p style="font-style: italic; font-size: 1.5em;">Unable to find any light transmission data for this block</p>
    </section>
    <section id="natLightSection" style="display: none;">
      <h2>Natural Light</h2>
      <dl class='inline-flex'>
        <dt id='natLightDateLabel'>Date:</dt>
        <dd id="natLightDate"></dd>
      </dl>
      <figure class="testImg" id="natLightImgFigW" style="display: none;">
        <img id="natLightImgW" height="360"/>
        <figcaption id="natLightImgFigCaption4">Wide End</figcaption>
      </figure>
      <figure class="testImg" id="natLightImgFigN" style="display: none;">
        <img id="natLightImgN" height="360"/>
        <figcaption id="natLightImgFigCaption5">Narrow End</figcaption>
      </figure>
    </section>
    <section id="natLightNoInfo" style="display: none;">
      <p style="font-style: italic; font-size: 1.5em;">Unable to find any natural light data for this block</p>
    </section>
    <section id="scintSection" style="display: none;">
      <h2 id="scintSectionLabel">Scintillation</h2>
      <dl class='inline-flex'>
        <dt id='scintillationLabel'>Scintillation:</dt>
        <dd id="scintillation"></dd>
        <dt id='scintRatioLabel'>Ratio:</dt>
        <dd id="scintRatio" style="font-weight: bold;"></dd>
        <dt id='scintDateLabel'>Date:</dt>
        <dd id="scintDate"></dd>
      </dl>
    </section>
    <section id="scintNoInfo" style="display: none;">
      <p style="font-style: italic; font-size: 1.5em;">Unable to find any scintillation data for this block</p>
    </section>
  </section>
  <section id="findBlocks" style="display: none;">
    <form action="javascript:filter()" style="display: inline;">
      <label style="display: inline-block; width: 90px;">Shipment: </label><input style="width: 80px;" type="text" tabindex="1" id="inputShipment">
      <button>submit</button>
    </form>
    <button onclick="clearInputShipment()" style="display: inline;">clear</button><br>
    <form action="javascript:filter()" style="display: inline;">
      <label style="display: inline-block; width: 90px;">Status: </label><input style="width: 80px;" type="text" tabindex="2" id="inputStatus">
      <button>submit</button>
    </form>
    <button onclick="clearInputStatus()" style="display: inline;">clear</button><br>
    <form action="javascript:filter()" style="display: inline;">
      <label style="display: inline-block; width: 90px;">Block Design: </label><input style="width: 80px;" type="text" tabindex="3" id="inputBlock">
      <button>submit</button>
    </form>
    <button onclick="clearInputBlock()" style="display: inline;">clear</button><br>
    <button onclick="loadFindBlockInfo()" style="margin: 1em 0em;">back</button>
    <section style="margin: 1em 0em">
      <span>Blocks Found:</span>
      <span id="blocksCount"></span>
    </section>
    <table id="blocksTable" class="nowrap display cell-border" style="width: 100%;">
      <thead>
        <tr>
          <th>dbn</th>
          <th>block</th>
          <th>status</th>
          <th>pregrade</th>
          <th>shipment</th>
          <th>sector</th>
          <th>powder</th>
          <th>bucket</th>
          <th>moldSeries</th>
          <th>emptyMoldMass</th>
          <th>filledMoldMass</th>
          <th>tungstenMass</th>
          <th>tungstenFillingDate</th>
          <th>epoxyBatch</th>
          <th>resinMass</th>
          <th>hardenerMass</th>
          <th>epoxyFillingTime</th>
          <th>epoxyFillingDate</th>
          <th>dL</th>
          <th>dBT</th>
          <th>dBB</th>
          <th>dBH</th>
          <th>dST</th>
          <th>dSB</th>
          <th>dSH</th>
          <th>toleranceMse</th>
          <th>volume</th>
          <th>mass</th>
          <th>density</th>
          <th>densityDate</th>
          <th>goodEnd</th>
          <th>fiberPercentage</th>
          <th>tower1</th>
          <th>tower2</th>
          <th>tower3</th>
          <th>tower4</th>
          <th>missingRow</th>
          <th>thirteenHoles</th>
          <th>lightTransDate</th>
          <th>scintillation</th>
          <th>scintRatio</th>
          <th>scintDate</th>
          <th>natLightDate</th>
        </tr>
      </thead>
      <tbody id="blocksTableBody"></tbody>
    </table>
  </section>
  <script>
    // store each section's ID in an array for easy iteration:
    const allSectionPrefixes = ['blockDetails', 'density', 'lightTrans', 'natLight', 'scint']
    // store each section's value IDs in an array for easy iteration:
    const blockDetailsKeys = ['dbn', 'block', 'status', 'shipment', 'sector', 'comment']
    const densityKeys = ['volume', 'mass', 'density', 'densityDate']
    const lightTransKeys = ['goodEnd', 'fiberPercentage', 'missingRow', 'thirteenHoles', 'lightTransDate']
    const natLightKeys = ['natLightDate']
    const scintKeys = ['scintillation', 'scintRatio', 'scintDate']
    // store all image prefixes in an array for easy iteration
    const allImagePrefixes = ['lightTransImg', 'lightTransImgCropped', 'natLightImg']
    // store all testing image IDs in an array for easy iteration:
    const allTestingImgs = ['lightTransImgW', 'lightTransImgN', 'lightTransImgCroppedW', 'lightTransImgCroppedN', 'natLightImgW', 'natLightImgN']
    // IF a testing value has a key in this map, display the message when no data for that value was found
    // otherwise, hide the value and it's name by default
    const failureMessages = new Map()
    // IF a testing value has a key in this map and the block has this data, append this suffix (after a space) to the data
    // note that since status is block-specific, it is handled separately by updateField
    const suffixes = new Map([
      ['volume', 'mL'],
      ['mass', 'g'],
      ['density', 'g/mL'],
      ['fiberPercentage', '%'],
      ['scintillation', 'mV']
    ])
    // converts a status number to english so it can be added to the block information (the suffix that appears after the status number)
    const statusMap = new Map([
      ['0','(fiber set)'],
      ['1','(fibers in mold)'],
      ['2','(tungsten in mold)'],
      ['3','(potted)'],
      ['4','(machining)'],
      ['5','(ready for testing)'],
      ['5a','(A-grade, all tests good)'],
      ['5b','(B-grade, some tests bad)'],
      ['6','(ready to be shipped)'],
      ['7','(shipped, at BNL)'],
      ['8','(graveyard)']
    ])
    // maximum DBN (reject dbns larger than this)
    var maxDbn = 3498
    //
    const tableColumnsPrefixes = [
      'dbn',
      'block',
      'status',
      'pregrade',
      'shipment',
      'sector',
      'powder',
      'bucket',
      'moldSeries',
      'emptyMoldMass',
      'filledMoldMass',
      'tungstenMass',
      'tungstenFillingDate',
      'epoxyBatch',
      'resinMass',
      'hardenerMass',
      'epoxyFillingTime',
      'epoxyFillingDate',
      'dL',
      'dBT',
      'dBB',
      'dBH',
      'dST',
      'dSB',
      'dSH',
      'toleranceMse',
      'volume',
      'mass',
      'density',
      'densityDate',
      'goodEnd',
      'fiberPercentage',
      'tower1',
      'tower2',
      'tower3',
      'tower4',
      'missingRow',
      'thirteenHoles',
      'lightTransDate',
      'scintillation',
      'scintRatio',
      'scintDate',
      'natLightDate'
      ]
    // For both sheets
    const blocksSheetMap = new Map([
      ['dbn', 0],
      ['block', 2],
      ['status', 3],
      ['shipment', 4],
      ['comment', 6],
      ['sector', 7],
      ['powder', 14],
      ['bucket', 15],
      ['moldSeries', 16],
      ['emptyMoldMass', 17],
      ['filledMoldMass', 18],
      ['tungstenMass', 19],
      ['tungstenFillingDate', 21],
      ['epoxyBatch', 23],
      ['resinMass', 24],
      ['hardenerMass', 25],
      ['pottingNotes', 26],
      ['epoxyFillingTime', 27],
      ['epoxyFillingDate', 28],
      ['volume', 40],
      ['mass', 42],
      ['density', 44],
      ['densityDate', 45],
      ['goodEnd', 47],
      ['fiberPercentage', 49],
      ['tower1', 55],
      ['tower2', 56],
      ['tower3', 57],
      ['tower4', 58],
      ['missingRow', 59],
      ['thirteenHoles', 60],
      ['lightTransDate', 64],
      ['scintillation', 65],
      ['scintRatio', 67],
      ['scintDate', 69],
      ['natLightDate', 70],
      ['pregrade', 77]
    ])
    // array [Blocks DB, Blocks1364DB], where each element is a (large) 2D array
    var database
    // stores the expected dimensions for each block type
    const dimensionsMap = new Map([
    ['123', [5.5000,	2.0850,	2.0850,	1.9890,	1.8150,	1.8150,	1.9890]],
    ['4', [5.4460,	2.0850,	2.0820,	2.2740,	1.8180,	1.8150,	1.9900]],
    ['5', [5.3500,	2.0850,	2.0760,	2.2630,	1.8230,	1.8150,	1.9900]],
    ['6', [5.2700,	2.0850,	2.0710,	2.2530,	1.8280,	1.8150,	1.9900]],
    ['7', [5.2050,	2.0850,	2.0650,	2.2430,	1.8320,	1.8150,	1.9900]],
    ['8', [5.1550,	2.0850,	2.0600,	2.2340,	1.8370,	1.8150,	1.9890]],
    ['9', [5.1180,	2.0850,	2.0560,	2.2250,	1.8410,	1.8150,	1.9890]],
    ['10', [5.0940,	2.0850,	2.0510,	2.2160,	1.8460,	1.8150,	1.9890]],
    ['11', [5.0820,	2.0850,	2.0470,	2.2080,	1.8500,	1.8150,	1.9890]],
    ['12', [5.0810,	2.0850,	2.0420,	2.2010,	1.8530,	1.8150,	1.9890]],
    ['13', [5.0900,	2.0850,	2.0390,	2.1930,	1.8570,	1.8150,	1.9890]],
    ['14', [5.1100,	2.0850,	2.0350,	2.1860,	1.8600,	1.8150,	1.9890]],
    ['15', [5.1390,	2.0850,	2.0320,	2.1800,	1.8640,	1.8150,	1.9890]],
    ['16', [5.1770,	2.0850,	2.0280,	2.1740,	1.8670,	1.8150,	1.9890]],
    ['17', [5.2240,	2.0850,	2.0250,	2.1680,	1.8700,	1.8150,	1.9890]],
    ['18', [5.2790,	2.0850,	2.0230,	2.1620,	1.8720,	1.8150,	1.9890]],
    ['19', [5.3420,	2.0850,	2.0200,	2.1570,	1.8750,	1.8150,	1.9890]],
    ['20', [5.4120,	2.0850,	2.0180,	2.1520,	1.8770,	1.8150,	1.9890]],
    ['21', [5.4890,	2.0850,	2.0150,	2.1470,	1.8790,	1.8150,	1.9890]],
    ['22', [5.5720,	2.0850,	2.0130,	2.1420,	1.8810,	1.8150,	1.9890]],
    ['23', [5.6620,	2.0850,	2.0120,	2.1380,	1.8830,	1.8150,	1.9890]],
    ['24', [5.7580,	2.0850,	2.0100,	2.1330,	1.8850,	1.8150,	1.9890]]
    ])
    // changes to true when the "do not press" button is pressed, which changes the way image urls are obtained
    var slowMode = false
    // called when the web page is loaded—loads the database
    function getDatabaseOnLoad() {
      // create a timestamp to display     
      document.getElementById("currentDateAndTime").innerHTML = 'As of: ' + Date(Date.now()).toString()
      document.getElementById("currentDateAndTime").style.display = 'block'
      document.getElementById('loadingDatabase').style.display = 'block'
      google.script.run.withSuccessHandler(onSuccess).getDatabase()
      function onSuccess (gotDatabase) {
        if (gotDatabase == null) {
          alert('oops, fn gotDatabase returned null! unable to load database and testing folders from drive')
          document.getElementById('loadingDatabase').style.display = 'none'
          return
        } else if (gotDatabase[2] !== '') {
          // an error occured, so display an alert with the error message passed from script
          alert('an error occured while loading the database and testing fodlers: ' + gotDatabase[2])
          document.getElementById('loadingDatabase').style.display = 'none'
        } else {
          console.log('loaded database and testing folders without error')
          database = gotDatabase
          document.getElementById('loadingDatabase').style.display = 'none'
          document.getElementById('findBlockInfo').style.display = 'block'
        }
      }
    }
    
    // called when enter is pressed in text box or submit button is clicked
    function onSubmit() {
      // load the database if it hasn't been loaded
      if (database == null) {
        getDatabaseOnLoad()
        afterOnSubmit()
      } else {
        afterOnSubmit()
      }
      function afterOnSubmit () {
        // show that we're loading the block data
        document.getElementById("loadingBlockData").style.display = 'block'
        // grab the dbn from the input box
        var dbn = document.getElementById("inputDBN").value
        console.log('fetching information for DBN ' + dbn)
        // hide all block info and noInfo sections for them to be loaded if needed by loadTestingData
        for (let i = 0; i < allSectionPrefixes.length; i++) {
          document.getElementById(allSectionPrefixes[i] + 'Section').style.display = 'none'
          document.getElementById(allSectionPrefixes[i] + 'NoInfo').style.display = 'none'
        }
        // hide imagesSelection section for it to be loaded if needed by loadTestingData
        document.getElementById("imagesSelection").style.display = 'none'
        // and reset the checkboxes
        resetCheckboxes()
        // and reset text that isn't automatically reset in imagesSelection section
        document.getElementById("noImagesFound").style.display = 'none'
        document.getElementById("histogramWide").style.display = 'none'
        document.getElementById("histogramWide").href = '#'
        document.getElementById("histogramNarrow").style.display = 'none'
        document.getElementById("histogramNarrow").href = '#'
        // and reset the img src urls just in case one happens to be shown but on overwritten
        // (e.g. one LT cropped image returns a url and the other does not (e.g. DBN 78))
        for (let i = 0; i < allTestingImgs.length; i++) {
          document.getElementById(allTestingImgs[i]).src = '#'
        }
        // run loadTestingDataAsStringifiedJson and pass it's return data to a success handler
        console.log('loading testing data')
        loadTestingData(dbn)
      }
    }
    // takes array of string element ids and clears their innerHTML
    function clearElements(array) {
      for (let i = 0; i < array.length; i++) {
        document.getElementById(array[i]).innerHTML = ''
      }
    }
    // pulls the info with key id from blockDataMap and updates its innerHTML if it contains info
    // adds a suffix if one exists in suffixes (Map), and adds status suffix if the key is 'status'
    // (status is handle differently since it can't be integrated into status map since it's block-specific)
    // hides the element AND its label if failureMessages does not have the key
    // otherwise sets the innerHTML to the key's failure message
    function updateField(blockDataMap, id) {
      if (dataPresent(blockDataMap.get(id))) {
        document.getElementById(id).innerHTML = blockDataMap.get(id)
        if (suffixes.has(id) || id === 'status') {
          if (id === 'status') {
            document.getElementById(id).innerHTML += ' ' + statusMap.get(blockDataMap.get('status'))
          } else {
            document.getElementById(id).innerHTML += ' ' + suffixes.get(id)
          }
        }
        document.getElementById(id).style.display = 'inline'
        document.getElementById(id + 'Label').style.display = 'inline'
      } else {
        if (failureMessages.has(id)) {
          document.getElementById(id).innerHTML = failureMessages.get(id)
        } else {
          document.getElementById(id).style.display = 'none'
          document.getElementById(id + 'Label').style.display = 'none'
        }
      }
    }
    // Checks if a value (say, returned by a map) is significant (not null, empty, #NUM!, or #DIV/0!)
    function dataPresent (data) {
      return (data != null && data != '' && data != '#NUM!' && data != '#DIV/0!' && data != 'NaN')
    }
    // takes a map and an array of string ids and checks if any map values for key ids have data
    // "has data" is determined by function dataPresent
    function someDataPresent(map, array) {
      return array.some(function(element) {
        return dataPresent(map.get(element))
      })
    }
    // loads testing data, updates fields, and unhides relevant sections based on the data present
    function loadTestingData (dbn) {
      let blockMap = new Map()
      // The dbn passed from the html doesn't seem to be an int, so make sure it is (dbn 1 would return info for dbn 10 otherwise)
      dbn = Math.floor(dbn)
      // Reject invalid dbns and choose the correct sheet and map for valid dbns
      if (isNaN(dbn) || dbn < 0 || dbn > maxDbn) {
        alert('that dbn was invalid or out of range')
        document.getElementById("loadingBlockData").style.display = 'none'
        document.getElementById("currentDateAndTime").style.display = 'none'
      } else if (dbn < 2000) {
        var currentSheet = database[0]
        var currentRowOffset = 1
      } else {
        var currentSheet = database[1]
        var currentRowOffset = 1 - 2000
      }
      // dbn is good, so pull data from the database
      let row = dbn + currentRowOffset
      // Construct a cell range in A1 format for the block's row
      let blockData = currentSheet[row]
      // grab each dimension measurement in an array
      let dimensions = blockData.slice(33, 40)
      // Create a new map that maps block properites to their actual values
      for (let pair of blocksSheetMap) {
        // Logger.log("blocksSheetMap has key " + pair[0] + " -> " + blockData[pair[1]]);
        blockMap.set(pair[0], blockData[pair[1]])
      }
      // first check for ALL nulls, in which case there's no information for this dbn
      let blockMapArray = Array.from(blockMap)
      let allNull = blockMapArray.every(function(element) {
        return element == null || !dataPresent(element[1])
      })
      if (allNull) {
        // no data at all for this dbn
        document.getElementById("loadingBlockData").style.display = 'none'
        alert('no information at all was found for this DBN')
        document.getElementById("currentDateAndTime").style.display = 'none'
        return
      }
      let getImageUrlsRun = false
      let toGetImageUrls = [blockMap.get('dbn'), blockMap.get('lightTransDate'), blockMap.get('natLightDate')]

      // BLOCK DETAILS  (check if data is present)
      const tungstenTableEntries = ['powder', 'bucket', 'moldSeries', 'emptyMoldMass', 'filledMoldMass', 'tungstenMass', 'tungstenFillingDate']
      const epoxyTableEntries = ['epoxyBatch', 'resinMass', 'hardenerMass', 'pottingNotes', 'epoxyFillingTime', 'epoxyFillingDate']
      if (someDataPresent(blockMap, blockDetailsKeys)) {
        // some block info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("blockDetailsSection").style.display = 'block'
        for (let i = 0; i < blockDetailsKeys.length; i++) {
          updateField(blockMap, blockDetailsKeys[i])
        }
        let hasTungstenData = tungstenTableEntries.some(function(element) {
          return dataPresent(blockMap.get(element)) && element !== 'tungstenMass'
        })
        //tungsten table
        if (hasTungstenData) {
          for (let i = 0; i < tungstenTableEntries.length; i++) {
            let entry = tungstenTableEntries[i]
            document.getElementById(entry).innerHTML = blockMap.get(entry)
          }
          document.getElementById('showTungstenTableBtn').style.display = 'block'
        } else {
          document.getElementById('showTungstenTableBtn').style.display = 'none'
          document.getElementById('tungstenTable').style.display = 'none'
        }
        //epoxy table
        if (someDataPresent(blockMap, epoxyTableEntries)) {
          for (let i = 0; i < epoxyTableEntries.length; i++) {
            let entry = epoxyTableEntries[i]
            document.getElementById(entry).innerHTML = blockMap.get(entry)
          }
          document.getElementById('showEpoxyTableBtn').style.display = 'block'
        } else {
          document.getElementById('showEpoxyTableBtn').style.display = 'none'
          document.getElementById('epoxyTable').style.display = 'none'
        }
        //pregrade
        if (dataPresent(blockMap.get('pregrade')) && dbn < 2000) {
          document.getElementById('pregrade').innerHTML = blockMap.get('pregrade')
          let grade = grade_pregrade(blockMap.get('pregrade'))
          if (grade != null) {
            document.getElementById('pregrade').style.color = testColors[grade]
            document.getElementById('pregrade').style.fontWeight = 'bold'
          } else {
            document.getElementById('pregrade').style.color = black
            document.getElementById('pregrade').style.fontWeight = 'normal'
          }
          document.getElementById('pregrade').style.display = 'inline'
          document.getElementById('pregrade' + 'Label').style.display = 'inline'
        } else {
          document.getElementById('pregrade').style.display = 'none'
          document.getElementById('pregrade' + 'Label').style.display = 'none'
        }
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < blockDetailsKeys.length; i++) {
          document.getElementById(blockDetailsKeys[i]).innerHTML = ''
        }
        document.getElementById("blockDetailsNoInfo").style.display = 'block'
      }
      
      // DENSITY  (check if data is present)
      if (someDataPresent(blockMap, densityKeys)) {
        // some block info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("densitySection").style.display = 'block'
        for (let i = 0; i < densityKeys.length; i++) {
          updateField(blockMap, densityKeys[i])
        }
        // color coding
        let testGrades = []
        let tolerancesGrades = []
        let grade = grade_density(blockMap.get('density'))
        document.getElementById('density').style.color = testColors[grade]
        testGrades.push(grade)
        let hasDimensionInfo = false
        for (let i = 0; i < dimensions.length; i++) {
          if (dataPresent(dimensions[i])) {
            hasDimensionInfo = true
            break
          }
        }
        if (hasDimensionInfo) {
          let block = blockMap.get('block')
          const tolerancesTableEntries = ['L', 'BT', 'BB', 'BH', 'ST', 'SB', 'SH']
          for (let i = 0; i < dimensions.length; i++) {
            let deviation = dimensions[i] - dimensionsMap.get(block)[i]
            if (deviation <= 0) {
              document.getElementById(tolerancesTableEntries[i]).innerHTML = (deviation).toFixed(4)
            } else {
              document.getElementById(tolerancesTableEntries[i]).innerHTML = '+' + (deviation).toFixed(4)
            }
          }
          // color coding
          for (let i = 0; i < dimensions.length; i++) {
            let deviation = dimensions[i] - dimensionsMap.get(block)[i]
            if (i === 0) {
              let grade = grade_dL(deviation)
              document.getElementById(tolerancesTableEntries[i]).style.color = testColors[grade]
              testGrades.push(grade)
              tolerancesGrades.push(grade)
            } else {
              document.getElementB
              let grade = grade_otherDev(deviation)
              document.getElementById(tolerancesTableEntries[i]).style.color = testColors[grade]
              testGrades.push(grade)
              tolerancesGrades.push(grade)
            }
          }
          document.getElementById('densitySectionLabel').style.color = testColors[Math.max(...testGrades)]
          document.getElementById('showTolerancesTableBtn').style.color = testColors[Math.max(...tolerancesGrades)]
          document.getElementById('showTolerancesTableBtn').style.display = 'inline'
        } else {
          document.getElementById('showTolerancesTableBtn').style.display = 'none'
          document.getElementById('tolerancesTable').style.display = 'none'
        } 
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < densityKeys.length; i++) {
          document.getElementById(densityKeys[i]).innerHTML = ''
        }
        document.getElementById("densityNoInfo").style.display = 'block'
      }

      // LIGHT TRANSMISSION (check if data is present)
      let hasLightTransData = lightTransKeys.some(function(element) {
        return dataPresent(blockMap.get(element)) && element !== 'fiberPercentage'
      })
      if (hasLightTransData) {
        // some block info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("lightTransSection").style.display = 'block'
        for (let i = 0; i < lightTransKeys.length; i++) {
          updateField(blockMap, lightTransKeys[i])
        }
        const towerTableEntries = ['tower1', 'tower2', 'tower3', 'tower4']
        if (someDataPresent(blockMap, towerTableEntries)) {
          for (let i = 0; i < towerTableEntries.length; i++) {
            let entry = towerTableEntries[i]
            document.getElementById(entry).innerHTML = blockMap.get(entry)
          }
          document.getElementById('showTowerTableBtn').style.display = 'inline'
        } else {
          document.getElementById('showTowerTableBtn').style.display = 'inline'
          document.getElementById('towerTable').style.display = 'inline'
        }
        // color coding
        let testGrades = []
        let towerGrades = []
        let grade = grade_fiberPercentage(blockMap.get('fiberPercentage'))
        document.getElementById('fiberPercentage').style.color = testColors[grade]
        testGrades.push(grade)
        for (let i = 0; i < towerTableEntries.length; i++) {
          let tower = towerTableEntries[i]
          let grade = grade_tower(blockMap.get(tower))
          document.getElementById(tower).style.color = testColors[grade]
          testGrades.push(grade)
          towerGrades.push(grade)
        }
        document.getElementById('showTowerTableBtn').style.color = testColors[Math.max(...towerGrades)]
        let gradeMR = grade_missingRow(blockMap.get('missingRow'))
        document.getElementById('missingRow').style.color = testColors[gradeMR]
        testGrades.push(gradeMR)
        let gradeTH = grade_thirteenHoles(blockMap.get('thirteenHoles'))
        document.getElementById('thirteenHoles').style.color = testColors[gradeTH]
        testGrades.push(gradeTH)
        document.getElementById('lightTransSectionLabel').style.color = testColors[Math.max(...testGrades)]
        // and run getImageUrls
        document.getElementById("imagesSelection").style.display = 'block'
        document.getElementById("loadingImages").style.display = 'block'
        console.log('fetching image urls')
        if (slowMode) {
          getImageUrlsSlow(toGetImageUrls[0])
        } else {
          google.script.run.withSuccessHandler(onGetImageUrlsSuccess).getImageUrls(toGetImageUrls)
          google.script.run.withSuccessHandler(onGetHistogramsSuccess).getHistograms(toGetImageUrls)
        }
        getImageUrlsRun = true
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < lightTransKeys.length; i++) {
          document.getElementById(lightTransKeys[i]).innerHTML = ''
        }
        document.getElementById("lightTransNoInfo").style.display = 'block'
      }
      
      // NATURAL LIGHT (check if data is present)
      if (someDataPresent(blockMap, natLightKeys)) {
        // some info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("natLightSection").style.display = 'block'
        for (let i = 0; i < natLightKeys.length; i++) {
          updateField(blockMap, natLightKeys[i])
        }
        // run getImageUrls if it hasn't been run by light transmission
        if (!getImageUrlsRun) {
          // run getImageUrls if it hasn't been run
          document.getElementById("imagesSelection").style.display = 'block'
          document.getElementById("loadingImages").style.display = 'block'
          console.log('fetching image urls')
          if (slowMode) {
            getImageUrlsSlow(toGetImageUrls[0])
          } else {
            google.script.run.withSuccessHandler(onGetImageUrlsSuccess).getImageUrls(toGetImageUrls)
            google.script.run.withSuccessHandler(onGetHistogramsSuccess).getHistograms(toGetImageUrls)
          }
          getImageUrlsRun = true
        }
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < natLightKeys.length; i++) {
          document.getElementById(natLightKeys[i]).innerHTML = ''
        }
        document.getElementById("natLightNoInfo").style.display = 'block'
        // I don't need to run getImageUrls, so if light transmission didn't run it, then we don't need any of the image checkboxes
        // AND we need to reset them (if they are checked, uncheck them and toggle)
        if (!getImageUrlsRun) {
          console.log('determined there was no need to search for images')
          resetCheckboxes();
        }
      }
      
      // SCINTILLATION (check if data is present)
      if (someDataPresent(blockMap, scintKeys)) {
        // some info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("scintSection").style.display = 'block'
        for (let i = 0; i < scintKeys.length; i++) {
          updateField(blockMap, scintKeys[i])
        }
        let grade = grade_scintRatio(blockMap.get('scintRatio'))
        document.getElementById('scintRatio').style.color = testColors[grade]
        document.getElementById('scintSectionLabel').style.color = testColors[grade]
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < scintKeys.length; i++) {
          document.getElementById(scintKeys[i]).innerHTML = ''
        }
        document.getElementById("scintNoInfo").style.display = 'block'
      }
      
      // now hide the loading block data text...
      document.getElementById("loadingBlockData").style.display = 'none'
    }
    // resets a checkbox to unchecked
    function resetCheckbox (imagePrefix) {
      // if a checkbox is checked, uncheck it and call it's toggle function to hide images
      if (document.getElementById('CBshow-' + imagePrefix).checked == true) {
        document.getElementById('CBshow-' + imagePrefix).checked = false
        toggleImages(imagePrefix)
      }
      // then hide the checkbox
      document.getElementById('CBshow-' + imagePrefix + 'Section').style.display = 'none'
    }

    // reset all checkboxes individually and hide checkboxes section
    function resetCheckboxes () {
      for (let i = 0; i < allImagePrefixes.length; i++) {
        resetCheckbox(allImagePrefixes[i])
      }
      document.getElementById("allCheckboxes").style.display = 'none'
    }

    // does not perfectly nicely handle the situation where ONE end's image is present and the other is not..
    // since this case is so rare, it tries to load both (and if one happens to not have an image, a placeholder is displayed)
    function onGetImageUrlsSuccess (imageUrls) {
      // check if getImageUrls returned any urls...
      if (imageUrls.every((element) => element == null)) {
        // ...NO image urls were returned, so there's no image data to display
        document.getElementById("loadingImages").style.display = 'none'
        document.getElementById("noImagesFound").style.display = 'block'
        return
      }
      // first set all not null urls to their image srcs
      imageUrls.forEach((element, index) => {
        if (element != null) {
          if (index < 4) {
            document.getElementById(allTestingImgs[index]).src = element
          } else {
            document.getElementById(allTestingImgs[index]).src = element[0]
            let imageUrlsIndexToEnd = new Map([[4, 'Wide End'], [5, 'Narrow End']])
            let positionCodeToPosition = new Map([[1, '(pictured on left)'], [2, '(pictured on right)']])
            console.log(imageUrls[index][1])
            if (imageUrls[index][1] !== 0) {
              document.getElementById('natLightImgFigCaption' + index).innerHTML = imageUrlsIndexToEnd.get(index) + ' ' + positionCodeToPosition.get(imageUrls[index][1])
            } else {
              document.getElementById('natLightImgFigCaption' + index). innerHTML = imageUrlsIndexToEnd.get(index)
            }
          }
        }
      });
      // determine which checkboxes / image sections need to be displayed
      for (let i = 0; i < allImagePrefixes.length; i++) {
        if (imageUrls[2*i] != null || imageUrls[2*i + 1] != null) {
          // one of this section's images is present, so display its checkbox
          document.getElementById('CBshow-' + allImagePrefixes[i] + 'Section').style.display = 'block'
        } else {
          // this section is not needed—reset its checkbox
          resetCheckbox(allImagePrefixes[i])
        }
      }
      // finally, display the checkboxes section
      document.getElementById("loadingImages").style.display = 'none'
      document.getElementById("allCheckboxes").style.display = 'block'
    }

    function onGetHistogramsSuccess (histogramUrls) {
      if (histogramUrls[0] != null) {
        document.getElementById('histogramWide').href = histogramUrls[0]
        document.getElementById('histogramWide').style.display = 'block'
      } else {
        document.getElementById('histogramWide').style.display = 'none'
      }
      if (histogramUrls[1] != null) {
        document.getElementById('histogramNarrow').href = histogramUrls[1]
        document.getElementById('histogramNarrow').style.display = 'block'
      } else {
        document.getElementById('histogramNarrow').style.display = 'none'
      }
    }

    function getImageUrlsSlow (dbn) {
      // check if getImageUrls returned any urls...
      if (bigArray[dbn] == null) {
        console.log('bigArray was null at index: ' + dbn)
        document.getElementById("loadingImages").style.display = 'none'
        document.getElementById("noImagesFound").style.display = 'block'
      } else {
        imageUrls = bigArray[dbn]
        if (imageUrls.every((element) => element == null)) {
          // ...NO image urls were returned, so there's no image data to display
          document.getElementById("loadingImages").style.display = 'none'
          document.getElementById("noImagesFound").style.display = 'block'
          return
        }
        // first set all not null urls to their image srcs
        imageUrls.forEach((element, index) => {
          if (element != null) {
            document.getElementById(allTestingImgs[index]).src = element[0]
          }
        });
        // determine which checkboxes / image sections need to be displayed
        for (let i = 0; i < allImagePrefixes.length; i++) {
          if (imageUrls[2*i] != null || imageUrls[2*i + 1] != null) {
            // one of this section's images is present, so display its checkbox
            document.getElementById('CBshow-' + allImagePrefixes[i] + 'Section').style.display = 'block'
          } else {
            // this section is not needed—reset its checkbox
            resetCheckbox(allImagePrefixes[i])
          }
        }
        // add suffixes to figure captions on NL images (left or right) if needed
        let imageUrlsIndexToEnd = new Map([[4, 'Wide End'], [5, 'Narrow End']])
        let positionCodeToPosition = new Map([[1, '(pictured on left)'], [2, '(pictured on right)']])
        for (let i = 4; i < imageUrls.length; i++) {
          if (imageUrls[i] != null) {
            if (imageUrls[i][2] != 0) {
              document.getElementById('natLightImgFigCaption' + i).innerHTML = imageUrlsIndexToEnd.get(i) + ' ' + positionCodeToPosition.get(imageUrls[i][2])
            } else {
              document.getElementById('natLightImgFigCaption' + i). innerHTML = imageUrlsIndexToEnd.get(i)
            }
          }
        }
        // finally, display the checkboxes section
        document.getElementById("loadingImages").style.display = 'none'
        document.getElementById("allCheckboxes").style.display = 'block'
      }
    }

    // takes an image name prefix (e.g. lightTransImg, lightTransImgCropped, or natLightImg)
    // and toggles the visibility of the corresponding wide and narrow images
    function toggleImages(imagePrefix) {
      let fig1 = document.getElementById(imagePrefix + 'FigW')
      let fig2 = document.getElementById(imagePrefix + 'FigN')
      if (fig1.style.display === "none" || fig2.style.display === "none") {
        fig1.style.display = "block"
        fig2.style.display = "block"
      } else {
        fig1.style.display = "none"
        fig2.style.display = "none"
      }
    }
    // changes the way image urls are obtained
    function madness () {
      alert('loading ALL image urls, do not submit another dbn before this request completes (should take about 90 seconds)')
      slowMode = true
      google.script.run.withSuccessHandler(onSuccess).loadBigArray()
      function onSuccess (data) {
        if (data == null) {
          console.log('bigArray was null :(')
          alert('there was an error fetching ALL image urls')
        } else {
          bigArray = data
          console.log('loaded bigArray')
          alert('loaded ALL image urls')
        }
      }
    }
    // hides/shows the tungsten table
    function toggleTungstenTable () {
      if (document.getElementById('tungstenTable').style.display === 'none') {
        document.getElementById('tungstenTable').style.display = 'block'
        document.getElementById('showTungstenTableBtn').innerHTML = 'Hide Tungsten Powder Infomation'
      } else {
        document.getElementById('tungstenTable').style.display = 'none'
        document.getElementById('showTungstenTableBtn').innerHTML = 'Show Tungsten Powder Information'
      }
    }
    // hides/shows the epoxy table
    function toggleEpoxyTable () {
      if (document.getElementById('epoxyTable').style.display === 'none') {
        document.getElementById('epoxyTable').style.display = 'block'
        document.getElementById('showEpoxyTableBtn').innerHTML = 'Hide Epoxy Information'
      } else {
        document.getElementById('epoxyTable').style.display = 'none'
        document.getElementById('showEpoxyTableBtn').innerHTML = 'Show Epoxy Information'
      }
      // finally, display the checkboxes section
      document.getElementById("loadingImages").style.display = 'none'
      document.getElementById("allCheckboxes").style.display = 'block'
    }
    // hides/shows the tolerances table
    function toggleTolerancesTable () {
      if (document.getElementById('tolerancesTable').style.display === 'none') {
        document.getElementById('tolerancesTable').style.display = 'block'
        document.getElementById('showTolerancesTableBtn').innerHTML = 'Hide Tolerances'
      } else {
        document.getElementById('tolerancesTable').style.display = 'none'
        document.getElementById('showTolerancesTableBtn').innerHTML = 'Show Tolerances'
      }
    }
    // hides/shows the tower table
    function toggleTowerTable () {
      if (document.getElementById('towerTable').style.display === 'none') {
        document.getElementById('towerTable').style.display = 'block'
        document.getElementById('showTowerTableBtn').innerHTML = 'Hide Tower Information'
      } else {
        document.getElementById('towerTable').style.display = 'none'
        document.getElementById('showTowerTableBtn').innerHTML = 'Show Tower Information'
      }
    }
    var filterShipmentValue
    var filterStatusValue
    var filterBlockValue
    function filter () {
      filterShipmentValue = document.getElementById('inputShipment').value
      filterStatusValue = document.getElementById('inputStatus').value
      filterBlockValue = document.getElementById('inputBlock').value
      loadBlocksTable()
    }
    function clearInputShipment () {
      document.getElementById('inputShipment').value = null
      filter()
    }
    function clearInputStatus () {
      document.getElementById('inputStatus').value = null
      filter()
    }
    function clearInputBlock () {
      document.getElementById('inputBlock').value = null
      filter()
    }
    function loadBlocksTable () {
      let dataTable = $('#blocksTable').DataTable()
      dataTable.clear()
      let sheet1 = [...database[0]]
      sheet1.shift()
      let sheet2 = [...database[1]]
      sheet2.shift()
      let mergedSheet = sheet1.concat(sheet2)
      for (let i = 0; i < mergedSheet.length; i++) {
        if (dataPresent(mergedSheet[i][blocksSheetMap.get('block')])
        && (filterShipmentValue == null || filterShipmentValue == '' || filterShipmentValue === mergedSheet[i][blocksSheetMap.get('shipment')])
        && (filterStatusValue == null || filterStatusValue == '' || filterStatusValue === mergedSheet[i][blocksSheetMap.get('status')])
        && (filterBlockValue == null || filterBlockValue == '' || filterBlockValue === mergedSheet[i][blocksSheetMap.get('block')])) {
          let rowData = new Array(tableColumnsPrefixes.length)
          let dimensions = mergedSheet[i].slice(33, 40)
          let tolerances = [null, null, null, null, null, null, null]
          for (let j = 0; j < tableColumnsPrefixes.length; j++) {
            let name = tableColumnsPrefixes[j]
            if (['dL', 'dBT', 'dBB', 'dBH', 'dST', 'dSB', 'dSH'].includes(name)) {
              let k = ['dL', 'dBT', 'dBB', 'dBH', 'dST', 'dSB', 'dSH'].findIndex((value) => name === value)
              let deviation
              let block = mergedSheet[i][blocksSheetMap.get('block')]
              if (!isNaN(dimensions[k]) && dimensions[k] !== 0 && dimensions[k] !== '') {
                deviation = dimensions[k] - dimensionsMap.get(block)[k]
                tolerances[k] = deviation
                rowData[j] = (deviation).toFixed(4)
              } else {
                rowData[j] = null
              }
            } else if (['tower1', 'tower2', 'tower3', 'tower4'].includes(name) && !isNaN(mergedSheet[i][blocksSheetMap.get(tableColumnsPrefixes[j])])) {
              rowData[j] = parseFloat(mergedSheet[i][blocksSheetMap.get(tableColumnsPrefixes[j])]).toFixed(2)
            } else if (name == 'pregrade') {
              if (i < sheet1.length) {
                rowData[j] = mergedSheet[i][blocksSheetMap.get(tableColumnsPrefixes[j])]
              } else {
                rowData[j] = null
              }
            } else if (name === 'toleranceMse') {
              if (tolerances.every((value) => value != null)) {
                tolerances.forEach((value, index, array) => array[index] = value * value)
                rowData[j] = ((tolerances.reduce((a, b) => (a + b))) / 7).toFixed(9)
              } else {
                rowData[j] = null
              }
            } else {
              rowData[j] = mergedSheet[i][blocksSheetMap.get(tableColumnsPrefixes[j])]
            }
          }
          dataTable.row.add(rowData)
        }
      }
      dataTable.draw()
      document.getElementById("blocksCount").innerHTML = dataTable.rows().count()
    }
    function loadFindBlockInfo () {
      document.getElementById('findBlockInfo').style.display = 'block'
      document.getElementById('findBlocks').style.display = 'none'
    }
    function loadFindBlocks () {
      document.getElementById('findBlocks').style.display = 'block'
      document.getElementById('findBlockInfo').style.display = 'none'
    }
  </script>
</body>
</html>