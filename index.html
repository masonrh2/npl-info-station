<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPL Block Information Station</title>
    <?!= include('css')?>
</head>
<body>
  <div class="header">
    <img src="https://drive.google.com/uc?id=1JLX7vfDnqgYd_OrgPNtvj1sqV8n4ANpd" />
    <h1>NPL Block Information Station</h1>
  </div><br>
  
  <form action="javascript:onSubmit()" style="display: block;">
    <label>DBN: </label><input type="text" id="inputDBN">
    <button id="submitDBN">Submit</button>
  </form>
  
  <p id="loadingBlockData" style="display: none;">Loading Block Data...</p>
  
  <section id="imagesSelection" style="display: none;  margin-top: 1em;">
    <section id="allCheckboxes" style="display: none;">
      <section id="CBshow-lightTransImgSection" style="display: none;">
        <input type="checkbox" id="CBshow-lightTransImg" onclick="toggleImages('lightTransImg')">
        <label for="CBshow-lightTransImg" id="CBshow-lightTransImgLabel">Show Light Transmission Original Images</label><br>
      </section>
      <section id="CBshow-lightTransImgCroppedSection" style="display: none;">
        <input type="checkbox" id="CBshow-lightTransImgCropped" onclick="toggleImages('lightTransImgCropped')">
        <label for="CBshow-lightTransImgCropped" id="CBshow-lightTransImgCroppedLabel">Show Light Transmission Cropped Images</label><br>
      </section>
      <section id="CBshow-natLightImgSection" style="display: none;">
        <input type="checkbox" id="CBshow-natLightImg" onclick="toggleImages('natLightImg')">
        <label for="CBshow-natLightImg" id="CBshow-natLightImgLabel">Show Natural Light Images</label>
      </section>
    </section>
    <div id="loadingImages" style="display: none;">Loading Images...</div>
    <div id="noImagesFound" style="display: none;">No Images Found</div>
  </section>
  
  <p id="currentDateAndTime" style="display: none;"></p>

  <section id="blockDetailsSection" style="display: none;">
    <h2>Block Details</h2>
    <dl class='inline-flex'>
      <dt id='dbnLabel'>DBN:</dt>
      <dd id="dbn"></dd>
      <dt id='blockLabel'>Block Design:</dt>
      <dd id="block"></dd>
      <dt id='statusLabel'>Status:</dt>
      <dd id="status"></dd>
      <dt id="shipmentLabel">BNL Shipment:</dt>
      <dd id="shipment"></dd>
      <dt id="sectorLabel">Sector:</dt>
      <dd id="sector"></dd>
      <dt id="commentLabel">Comment:</dt>
      <dd id="comment"></dd>
    </dl>
  </section>
  <section id="blockDetailsNoInfo" style="display: none;">
    <p style="font-style: italic; font-size: 1.5em;">Unable to find any block information for this dbn</p>
  </section>

  <section id="densitySection" style="display: none;">
    <h2>Density</h2>
    <dl class='inline-flex'>
      <dt id='volumeLabel'>Volume:</dt>
      <dd id="volume"></dd>
      <dt id='massLabel'>Mass:</dt>
      <dd id="mass"></dd>
      <dt id='densityLabel'>Density:</dt>
      <dd id="density"></dd>
      <dt id='densityDateLabel'>Date:</dt>
      <dd id="densityDate"></dd>
    </dl>
  </section>
  <section id="densityNoInfo" style="display: none;">
    <p style="font-style: italic; font-size: 1.5em;">Unable to find any density data for this block</p>
  </section>

  <section id="lightTransSection" style="display: none;">
    <h2>Light Transmission</h2>
    <dl class='inline-flex'>
      <dt id='fiberPercentageLabel'>Fiber Count:</dt>
      <dd id="fiberPercentage"></dd>
      <dt id='goodEndLabel'>Good End:</dt>
      <dd id="goodEnd"></dd>
      <dt id='missingRowLabel'>Missing Row:</dt>
      <dd id="missingRow"></dd>
      <dt id='thirteenHolesLabel'>13 Connected Holes:</dt>
      <dd id="thirteenHoles"></dd>
      <dt id='lightTransDateLabel'>Date:</dt>
      <dd id="lightTransDate"></dd>
    </dl>
    <figure class="testImg" id="lightTransImgFigW" style="display: none;">
      <img id="lightTransImgW" height="360"/>
      <figcaption>Wide End</figcaption>
    </figure>
    <figure class="testImg" id="lightTransImgFigN" style="display: none;">
      <img id="lightTransImgN" height="360"/>
      <figcaption>Narrow End</figcaption>
    </figure>
    <figure class="testImg" id="lightTransImgCroppedFigW" style="display: none;">
      <img id="lightTransImgCroppedW" height="360"/>
      <figcaption>Wide End</figcaption>
    </figure>
    <figure class="testImg" id="lightTransImgCroppedFigN" style="display: none;">
      <img id="lightTransImgCroppedN" height="360"/>
      <figcaption>Narrow End</figcaption>
    </figure>
  </section>
  <section id="lightTransNoInfo" style="display: none;">
    <p style="font-style: italic; font-size: 1.5em;">Unable to find any light transmission data for this block</p>
  </section>

  <section id="natLightSection" style="display: none;">
    <h2>Natural Light</h2>
    <dl class='inline-flex'>
      <dt id='natLightDateLabel'>Date:</dt>
      <dd id="natLightDate"></dd>
    </dl>
    <figure class="testImg" id="natLightImgFigW" style="display: none;">
      <img id="natLightImgW" height="360"/>
      <figcaption>Wide End</figcaption>
    </figure>
    <figure class="testImg" id="natLightImgFigN" style="display: none;">
      <img id="natLightImgN" height="360"/>
      <figcaption>Narrow End</figcaption>
    </figure>
  </section>
  <section id="natLightNoInfo" style="display: none;">
    <p style="font-style: italic; font-size: 1.5em;">Unable to find any natural light data for this block</p>
  </section>

  <section id="scintSection" style="display: none;">
    <h2>Scintillation</h2>
    <dl class='inline-flex'>
      <dt id='scinitllationLabel'>Scintillation:</dt>
      <dd id="scintillation"></dd>
      <dt id='scintRatioLabel'>Ratio:</dt>
      <dd id="scintRatio"></dd>
      <dt id='scintDateLabel'>Date:</dt>
      <dd id="scintDate"></dd>
    </dl>
  </section>
  <section id="scintNoInfo" style="display: none;">
    <p style="font-style: italic; font-size: 1.5em;">Unable to find any scintillation data for this block</p>
  </section>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>
    // store each section's ID in an array for easy iteration:
    var allSectionPrefixes = ['blockDetails', 'density', 'lightTrans', 'natLight', 'scint']
    // store each section's value IDs in an array for easy iteration:
    var blockDetailsKeys = ['dbn', 'block', 'status', 'shipment', 'sector', 'comment']
    var densityKeys = ['volume', 'mass', 'density', 'densityDate']
    var lightTransKeys = ['goodEnd', 'fiberPercentage', 'missingRow', 'thirteenHoles', 'lightTransDate']
    var natLightKeys = ['natLightDate']
    var scintKeys = ['scintillation', 'scintRatio', 'scintDate']
    // store all image prefixes in an array for easy iteration
    var allImagePrefixes = ['lightTransImg', 'lightTransImgCropped', 'natLightImg']
    // store all testing image IDs in an array for easy iteration:
    var allTestingImgs = ['lightTransImgW', 'lightTransImgN', 'lightTransImgCroppedW', 'lightTransImgCroppedN', 'natLightImgW', 'natLightImgN']
    // IF a testing value has a key in this map, display the message when no data for that value was found
    // otherwise, hide the value and it's name by default
    var failureMessages = new Map([
      ['comment', '(no comment found)']
    ])
    // IF a testing value has a key in this map and the block has this data, append this suffix (after a space) to the data
    // note that since status is block-specific, it is handled separately by updateField
    var suffixes = new Map([
      ['volume', 'mL'],
      ['mass', 'g'],
      ['density', 'g/mL'],
      ['fiberPercentage', '%'],
      ['scintillation', 'mV']
    ])
    // converts a status number to english so it can be added to the block information (the suffix that appears after the status number)
    var statusMap = new Map([
      ['0','(fiber set)'],
      ['1','(fibers in mold)'],
      ['2','(tungsten in mold)'],
      ['3','(potted)'],
      ['4','(machining)'],
      ['5','(ready for testing)'],
      ['5a','(A-grade, all tests good)'],
      ['5b','(B-grade, some tests bad)'],
      ['6','(ready to be shipped)'],
      ['7','(shipped, at BNL)'],
      ['8','(graveyard)']
    ])
    // maximum DBN (reject dbns larger than this)
    var maxDbn = 3498
    // For sheet Blocks DB
    var blocksSheet1Map = ([
      ['dbn', 0],
      ['block', 2],
      ['status', 3],
      ['shipment', 4],
      ['comment', 6],
      ['sector', 7],
      ['volume', 40],
      ['mass', 42],
      ['density', 44],
      ['densityDate', 45],
      ['goodEnd', 47],
      ['fiberPercentage', 49],
      ['missingRow', 59],
      ['thirteenHoles', 60],
      ['lightTransDate', 64],
      ['scintillation', 65],
      ['scintRatio', 67],
      ['scintDate', 69],
      ['natLightDate', 70]
    ])
    // For sheet Blocks1364DB
    var blocksSheet2Map = new Map([
      ['dbn', 0],
      ['block', 2],
      ['status', 3],
      ['shipment', 4],
      ['sector', 6],
      ['comment', 7],
      ['volume', 40],
      ['mass', 42],
      ['density', 44],
      ['densityDate', 45],
      ['goodEnd', 47],
      ['fiberPercentage', 49],
      ['missingRow', 59],
      ['thirteenHoles', 60],
      ['lightTransDate', 64],
      ['scintillation', 65],
      ['scintRatio', 67],
      ['scintDate', 69],
      ['natLightDate', 70]
    ])
    // [Blocks DB, Blocks1364DB]
    var database
    //
    function onGetDatabaseSuccess (returnedByGetDataBase) {
      database = returnedByGetDataBase
      console.log('loaded database')
      afterOnSubmit()
    }
    //
    function afterOnSubmit () {
      // create a timestamp to display     
      document.getElementById("currentDateAndTime").innerHTML = 'As of: ' + Date(Date.now()).toString()
      document.getElementById("currentDateAndTime").style.display = 'block'
      // show that we're loading the block data
      document.getElementById("loadingBlockData").style.display = 'block'
      // grab the dbn from the input box
      var dbn = document.getElementById("inputDBN").value
      console.log('fetching information for DBN ' + dbn)
      // hide all block info and noInfo sections for them to be loaded if needed by onLoadTestingDataSuccess
      for (let i = 0; i < allSectionPrefixes.length; i++) {
        document.getElementById(allSectionPrefixes[i] + 'Section').style.display = 'none'
        document.getElementById(allSectionPrefixes[i] + 'NoInfo').style.display = 'none'
      }
      // hide imagesSelection section for it to be loaded if needed by onLoadTestingDataSuccess
      document.getElementById("imagesSelection").style.display = 'none'
      // and reset the checkboxes
      resetCheckboxes()
      // and reset text that isn't automatically reset in imagesSelection section
      document.getElementById("noImagesFound").style.display = 'none'
      // and reset the img src urls just in case one happens to be shown but on overwritten
      // (e.g. one LT cropped image returns a url and the other does not (e.g. DBN 78))
      for (let i = 0; i < allTestingImgs.length; i++) {
        document.getElementById(allTestingImgs[i]).src = '#'
      }
      // run loadTestingDataAsStringifiedJson and pass it's return data to a success handler
      console.log('loading testing data')
      //google.script.run.withSuccessHandler(onLoadTestingDataSuccess).loadTestingDataAsStringifiedJSON(dbn)
      onLoadTestingDataSuccess(dbn)
    }
    // called when enter is pressed in text box or submit button is clicked
    function onSubmit() {
      // load the database if it hasn't been loaded
      if (database == null) {
        console.log('loading database')
        google.script.run.withSuccessHandler(onGetDatabaseSuccess).getDatabase()
      } else {
        afterOnSubmit()
      }
    }
    // takes array of string element ids and clears their innerHTML
    function clearElements(array) {
      for (let i = 0; i < array.length; i++) {
        document.getElementById(array[i]).innerHTML = ''
      }
    }
    // pulls the info with key id from blockDataMap and updates its innerHTML if it contains info
    // adds a suffix if one exists in suffixes (Map), and adds status suffix if the key is 'status'
    // (status is handle differently since it can't be integrated into status map since it's block-specific)
    // hides the element AND its label if failureMessages does not have the key
    // otherwise sets the innerHTML to the key's failure message
    function updateField(blockDataMap, id) {
      if (dataPresent(blockDataMap.get(id))) {
        document.getElementById(id).innerHTML = blockDataMap.get(id)
        if (suffixes.has(id)) {
          if (id === 'status') {
            document.getElementById(id).innerHTML += ' ' + statusMap.get(blockDataMap.get(status))
          } else {
            document.getElementById(id).innerHTML += ' ' + suffixes.get(id)
          }
        }
      } else {
        if (failureMessages.has(id)) {
          document.getElementById(id).innerHTML = failureMessages.get(id)
        } else {
          document.getElementById(id).style.display = 'none'
          document.getElementById(id + 'Label').style.display = 'none'
        }
      }
    }
    // Checks if a value (say, returned by a map) is significant (not null, empty, #NUM!, or #DIV/0!)
    function dataPresent (data) {
      return (data != null && data != '' && data != '#NUM!' && data != '#DIV/0!')
    }
    // takes a map and an array of string ids and checks if any map values for key ids have data
    // "has data" is determined by function dataPresent
    function someDataPresent(map, array) {
      return array.some(function(element) {
        return dataPresent(map.get(element))
      })
    }
    // called after loadTestingData (from google script) is called, and is called with what loadTestingData returned as the argument
    // handles updating all block data and chooses which sections to show and hide based on what loadTestingData returned
    // note that the argument is actually what's returned by loadTestingDataAsStringifiedJSON, since we don't seem to be able
    // to pass complicated objects like maps between the google script and the HTML script (if there is a way, I haven't found it) 
    function onLoadTestingDataSuccess (dbn) {
      let htmlMap
      // check for NaN
      if (isNaN(dbn)) {
        // return an empty map
        htmlMap = new Map()
      }
      // The dbn passed from the html doesn't seem to be an int, so make sure it is (dbn 1 would return info for dbn 10 otherwise)
      dbn = Math.floor(dbn)
      // Reject invalid dbns and choose the correct sheet and map for valid dbns
      if (dbn < 0 || dbn > maxDbn) {
        // Logger.log('the input dbn was out of range')
        htmlMap = new Map()
      } else if (dbn < 2000) {
        var currentSheet = database[0]
        var currentRowOffset = 1
        var currentSheetMap = blocksSheet1Map
      } else {
        var currentSheet = database[1]
        var currentRowOffset = 1 - 2000
        var currentSheetMap = blocksSheet2Map
      }
      if (htmlMap == null) {
        var row = dbn + currentRowOffset
        // Construct a cell range in A1 format for the block's row
        var blockData = currentSheet[row]
        // Create a new map that maps block properites to their actual values
        var blockMap = new Map()
        for (let pair of currentSheetMap) {
          // Logger.log("currentSheetMap has key " + pair[0] + " -> " + blockData[pair[1]]);
          blockMap.set(pair[0], blockData[pair[1]])
        }
        htmlMap = blockMap
      }
      

      // first check if ALL nulls were returned, in which case there's no information for this dbn
      // (or loadTestingData returned all null from an INVALID dbn submission)
      let htmlMapArray = Array.from(htmlMap)
      let allNull = htmlMapArray.every(function(element) {
        return element == null || !dataPresent(element[1])
      })
      if (allNull) {
        // no data at all for this dbn
        document.getElementById("loadingBlockData").style.display = 'none'
        alert('no information at all was found for this DBN')
        document.getElementById("currentDateAndTime").style.display = 'none'
        return
      }
      let getImageUrlsRun = false
      let toGetImageUrls = [blockMap.get('dbn'), blockMap.get('lightTransDate'), blockMap.get('natLightDate')]

      // BLOCK DETAILS  (check if data is present)
      if (someDataPresent(htmlMap, blockDetailsKeys)) {
        // some block info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("blockDetailsSection").style.display = 'block'
        for (let i = 0; i < blockDetailsKeys.length; i++) {
          updateField(htmlMap, blockDetailsKeys[i])
        }
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < blockDetailsKeys.length; i++) {
          document.getElementById(blockDetailsKeys[i]).innerHTML = ''
        }
        document.getElementById("blockDetailsNoInfo").style.display = 'block'
      }
      
      // DENSITY  (check if data is present)
      if (someDataPresent(htmlMap, densityKeys)) {
        // some block info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("densitySection").style.display = 'block'
        for (let i = 0; i < densityKeys.length; i++) {
          updateField(htmlMap, densityKeys[i])
        }
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < densityKeys.length; i++) {
          document.getElementById(densityKeys[i]).innerHTML = ''
        }
        document.getElementById("densityNoInfo").style.display = 'block'
      }

      // LIGHT TRANSMISSION (check if data is present)
      if (someDataPresent(htmlMap, lightTransKeys)) {
        // some block info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("lightTransSection").style.display = 'block'
        for (let i = 0; i < lightTransKeys.length; i++) {
          updateField(htmlMap, lightTransKeys[i])
        }
        // and run getImageUrls
        document.getElementById("imagesSelection").style.display = 'block'
        document.getElementById("loadingImages").style.display = 'block'
        console.log('fetching image urls')
        google.script.run.withSuccessHandler(onGetImageUrlsSuccess).getImageUrls(toGetImageUrls)
        getImageUrlsRun = true
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < lightTransKeys.length; i++) {
          document.getElementById(lightTransKeys[i]).innerHTML = ''
        }
        document.getElementById("lightTransNoInfo").style.display = 'block'
      }
      
      // NATURAL LIGHT (check if data is present)
      if (someDataPresent(htmlMap, natLightKeys)) {
        // some info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("natLightSection").style.display = 'block'
        for (let i = 0; i < natLightKeys.length; i++) {
          updateField(htmlMap, natLightKeys[i])
        }
        // run getImageUrls if it hasn't been run by light transmission
        if (!getImageUrlsRun) {
          // run getImageUrls if it hasn't been run
          document.getElementById("imagesSelection").style.display = 'block'
          document.getElementById("loadingImages").style.display = 'block'
          console.log('fetching image urls')
          google.script.run.withSuccessHandler(onGetImageUrlsSuccess).getImageUrls(toGetImageUrls)
          getImageUrlsRun = true
        }
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < natLightKeys.length; i++) {
          document.getElementById(natLightKeys[i]).innerHTML = ''
        }
        document.getElementById("natLightNoInfo").style.display = 'block'
        // I don't need to run getImageUrls, so if light transmission didn't run it, then we don't need any of the image checkboxes
        // AND we need to reset them (if they are checked, uncheck them and toggle)
        if (!getImageUrlsRun) {
          console.log('determined there was no need to search for images')
          resetCheckboxes();
        }
      }
      
      // SCINTILLATION (check if data is present)
      if (someDataPresent(htmlMap, scintKeys)) {
        // some info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("scintSection").style.display = 'block'
        for (let i = 0; i < scintKeys.length; i++) {
          updateField(htmlMap, scintKeys[i])
        }
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < scintKeys.length; i++) {
          document.getElementById(scintKeys[i]).innerHTML = ''
        }
        document.getElementById("scintNoInfo").style.display = 'block'
      }
      
      // now hide the loading block data text...
      document.getElementById("loadingBlockData").style.display = 'none'
    }
    // resets a checkbox to unchecked
    function resetCheckbox (imagePrefix) {
      // if a checkbox is checked, uncheck it and call it's toggle function to hide images
      if (document.getElementById('CBshow-' + imagePrefix).checked == true) {
        document.getElementById('CBshow-' + imagePrefix).checked = false
        toggleImages(imagePrefix)
      }
      // then hide the checkbox
      document.getElementById('CBshow-' + imagePrefix + 'Section').style.display = 'none'
    }
    // reset all checkboxes individually and hide checkboxes section
    function resetCheckboxes () {
      for (let i = 0; i < allImagePrefixes.length; i++) {
        resetCheckbox(allImagePrefixes[i])
      }
      document.getElementById("allCheckboxes").style.display = 'none'
    }

    // does not perfectly nicely handle the situation where ONE end's image is present and the other is not..
    // since this case is so rare, it tries to load both (and if one happens to not have an image, a placeholder is displayed)
    function onGetImageUrlsSuccess (imageUrls) {
      // check if getImageUrls returned any urls...
      if (imageUrls.every((element) => element == null)) {
        // ...NO image urls were returned, so there's no image data to display
        document.getElementById("loadingImages").style.display = 'none'
        document.getElementById("noImagesFound").style.display = 'block'
        return
      }
      // first set all not null urls to their image srcs
      imageUrls.forEach((element, index) => {
        if (element != null) {
          document.getElementById(allTestingImgs[index]).src = element
        }
      });
      // determine which checkboxes / image sections need to be displayed
      for (let i = 0; i < allImagePrefixes.length; i++) {
        if (imageUrls[2*i] != null || imageUrls[2*i + 1] != null) {
          // one of this section's images is present, so display its checkbox
          document.getElementById('CBshow-' + allImagePrefixes[i] + 'Section').style.display = 'block'
        } else {
          // this section is not neededâ€”reset its checkbox
          resetCheckbox(allImagePrefixes[i])
        }
      }
      // finally, display the checkboxes section
      document.getElementById("loadingImages").style.display = 'none'
      document.getElementById("allCheckboxes").style.display = 'block'
    }
    // takes an image name prefix (e.g. lightTransImg, lightTransImgCropped, or natLightImg)
    // and toggles the visibility of the corresponding wide and narrow images
    function toggleImages(imagePrefix) {
      let fig1 = document.getElementById(imagePrefix + 'FigW')
      let fig2 = document.getElementById(imagePrefix + 'FigN')
      if (fig1.style.display === "none" || fig2.style.display === "none") {
        fig1.style.display = "block"
        fig2.style.display = "block"
      } else {
        fig1.style.display = "none"
        fig2.style.display = "none"
      }
    }
  </script>
</body>
</html>