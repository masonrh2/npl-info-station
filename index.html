<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPL Block Information Station</title>
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <?!= include('css')?>
</head>
<body onload="getDatabaseOnLoad()" style="margin: 16px;">
  <div class="header" style="display: block; padding-bottom: 2em;">
    <img src="https://drive.google.com/uc?id=1JLX7vfDnqgYd_OrgPNtvj1sqV8n4ANpd" />
    <h1>NPL Block Information Station</h1>
  </div>
  <p id="loadingDatabase" style="display: none;">Loading Database...</p>
  <section id="notHeader" style="display: none;">
    <section style="display: inline-block; margin-left: 0em;">
      <form action="javascript:onSubmit()" style="display: inline;">
        <label>DBN: </label><input type="text" id="inputDBN">
        <button id="submitDBN">Submit</button>
      </form>
      <button id="massIteration" onclick="madness()">do not press</button>
      <button style="margin-left: 0; display: none;">Download as PDF</button>
    </section>
    <p id="loadingBlockData" style="display: none;">Loading Block Data...</p>
    
    <section id="imagesSelection" style="display: none;  margin-top: 1em;">
      <section id="allCheckboxes" style="display: none;">
        <section id="CBshow-lightTransImgSection" style="display: none;">
          <input type="checkbox" id="CBshow-lightTransImg" onclick="toggleImages('lightTransImg')">
          <label for="CBshow-lightTransImg" id="CBshow-lightTransImgLabel">Show Light Transmission Original Images</label><br>
        </section>
        <section id="CBshow-lightTransImgCroppedSection" style="display: none;">
          <input type="checkbox" id="CBshow-lightTransImgCropped" onclick="toggleImages('lightTransImgCropped')">
          <label for="CBshow-lightTransImgCropped" id="CBshow-lightTransImgCroppedLabel">Show Light Transmission Cropped Images</label><br>
        </section>
        <section id="CBshow-natLightImgSection" style="display: none;">
          <input type="checkbox" id="CBshow-natLightImg" onclick="toggleImages('natLightImg')">
          <label for="CBshow-natLightImg" id="CBshow-natLightImgLabel">Show Natural Light Images</label>
        </section>
      </section>
      <div id="loadingImages" style="display: none;">Loading Images...</div>
      <div id="noImagesFound" style="display: none;">No Images Found</div>
    </section>
    
    <p id="currentDateAndTime" style="display: none;"></p>

    <section id="blockDetailsSection" style="display: none;">
      <h2>Block Details</h2>
      <dl class='inline-flex'>
        <dt id='dbnLabel'>DBN:</dt>
        <dd id="dbn"></dd>
        <dt id='blockLabel'>Block Design:</dt>
        <dd id="block"></dd>
        <dt id='statusLabel'>Status:</dt>
        <dd id="status"></dd>
        <dt id="shipmentLabel">BNL Shipment:</dt>
        <dd id="shipment"></dd>
        <dt id="sectorLabel">Sector:</dt>
        <dd id="sector"></dd>
        <dt id="commentLabel">Comment:</dt>
        <dd id="comment"></dd>
        <section style="width: 100%; padding-top: 1em;">
          <button id="showTungstenTableBtn" style="display: none;" onclick="toggleTungstenTable()">Show Tungsten Powder Information</button>
          <table class="dimension" id="tungstenTable" style="display: none; padding-top: 1em; border-collapse: collapse; fill: #333;">
            <tr>
              <th>Powder</th><th>Bucket Number</th><th>Mold Series</th><th>Empty Mold Mass</th><th>Filled Mold Mass</th><th>Tungsten Mass</th><th>Filling Date</th>
            </tr>
            <tr>
              <td id="powder"></td><td id="bucket"></td><td id="moldSeries"></td><td id="emptyMoldMass"></td><td id="filledMoldMass"></td><td id="tungstenMass"></td><td id="tungstenFillingDate"></td>
            </tr>
          </table>
        </section>
        <section style="width: 100%; padding-top: 1em;">
          <button id="showEpoxyTableBtn" style="display: none;" onclick="toggleEpoxyTable()">Show Epoxy Information</button>
          <table class="dimension" id="epoxyTable" style="display: none; padding-top: 1em; border-collapse: collapse; fill: #333;">
            <tr>
              <th>Epoxy Batch</th><th>Resin Mass</th><th>Hardener Mass</th><th>Potting Notes</th><th>Epoxy Filling Time</th><th>Filling Date</th>
            </tr>
            <tr>
              <td id="epoxyBatch"></td><td id="resinMass"></td><td id="hardenerMass"></td><td id="pottingNotes"></td><td id="epoxyFillingTime"></td><td id="epoxyFillingDate"></td>
            </tr>
          </table>
        </section>
      </dl>
    </section>
    <section id="blockDetailsNoInfo" style="display: none;">
      <p style="font-style: italic; font-size: 1.5em;">Unable to find any block information for this dbn</p>
    </section>

    <section id="densitySection" style="display: none;">
      <h2>Density</h2>
      <dl class='inline-flex'>
        <dt id='volumeLabel'>Volume:</dt>
        <dd id="volume"></dd>
        <dt id='inSpecLabel'>Dimension in spec:</dt>
        <dd id="inSpec"></dd>
        <dt id='massLabel'>Mass:</dt>
        <dd id="mass"></dd>
        <dt id='densityLabel'>Density:</dt>
        <dd id="density"></dd>
        <dt id='densityDateLabel'>Date:</dt>
        <dd id="densityDate"></dd>
      </dl>
      <button id="showTolerancesTableBtn" style="display: none;" onclick="toggleTolerancesTable()">Show Tolerances</button>
      <table class="dimension" id="tolerancesTable" style="display: none; padding-top: 1em; border-collapse: collapse; fill: #333;">
        <tr>
          <th>ΔL</th><th>ΔBT</th><th>ΔBB</th><th>ΔBH</th><th>ΔST</th><th>ΔSB</th><th>ΔSH</th>
        </tr>
        <tr>
          <td id="L"></td><td id="BT"></td><td id="BB"></td><td id="BH"></td><td id="ST"></td><td id="SB"></td><td id="SH"></td>
        </tr>
      </table>
    </section>
    <section id="densityNoInfo" style="display: none;">
      <p style="font-style: italic; font-size: 1.5em;">Unable to find any density data for this block</p>
    </section>

    <section id="lightTransSection" style="display: none;">
      <h2>Light Transmission</h2>
      <dl class='inline-flex'>
        <dt id='fiberPercentageLabel'>Fiber Count:</dt>
        <dd id="fiberPercentage"></dd>
        <dt id='goodEndLabel'>Good End:</dt>
        <dd id="goodEnd"></dd>
        <dt id='missingRowLabel'>Missing Row:</dt>
        <dd id="missingRow"></dd>
        <dt id='thirteenHolesLabel'>13 Connected Holes:</dt>
        <dd id="thirteenHoles"></dd>
        <dt id='lightTransDateLabel'>Date:</dt>
        <dd id="lightTransDate"></dd>
      </dl>
      <button id="showTowerTableBtn" style="display: none;" onclick="toggleTowerTable()">Show Tower Information</button>
      <table class="dimension" id="towerTable" style="display: none; padding-top: 1em; border-collapse: collapse; fill: #333;">
        <tr>
          <th>T1 (BL)</th><th>T2 (BR)</th><th>T3 (TL)</th><th>T3 (TR)</th>
        </tr>
        <tr>
          <td id="tower1"></td><td id="tower2"></td><td id="tower3"></td><td id="tower4"></td>
        </tr>
      </table>
      <figure class="testImg" id="lightTransImgFigW" style="display: none;">
        <img id="lightTransImgW" height="360"/>
        <figcaption>Wide End</figcaption>
      </figure>
      <figure class="testImg" id="lightTransImgFigN" style="display: none;">
        <img id="lightTransImgN" height="360"/>
        <figcaption>Narrow End</figcaption>
      </figure>
      <figure class="testImg" id="lightTransImgCroppedFigW" style="display: none;">
        <img id="lightTransImgCroppedW" height="360"/>
        <figcaption>Wide End</figcaption>
      </figure>
      <figure class="testImg" id="lightTransImgCroppedFigN" style="display: none;">
        <img id="lightTransImgCroppedN" height="360"/>
        <figcaption>Narrow End</figcaption>
      </figure>
    </section>
    <section id="lightTransNoInfo" style="display: none;">
      <p style="font-style: italic; font-size: 1.5em;">Unable to find any light transmission data for this block</p>
    </section>

    <section id="natLightSection" style="display: none;">
      <h2>Natural Light</h2>
      <dl class='inline-flex'>
        <dt id='natLightDateLabel'>Date:</dt>
        <dd id="natLightDate"></dd>
      </dl>
      <figure class="testImg" id="natLightImgFigW" style="display: none;">
        <img id="natLightImgW" height="360"/>
        <figcaption id="natLightImgFigCaption4">Wide End</figcaption>
      </figure>
      <figure class="testImg" id="natLightImgFigN" style="display: none;">
        <img id="natLightImgN" height="360"/>
        <figcaption id="natLightImgFigCaption5">Narrow End</figcaption>
      </figure>
    </section>
    <section id="natLightNoInfo" style="display: none;">
      <p style="font-style: italic; font-size: 1.5em;">Unable to find any natural light data for this block</p>
    </section>

    <section id="scintSection" style="display: none;">
      <h2>Scintillation</h2>
      <dl class='inline-flex'>
        <dt id='scintillationLabel'>Scintillation:</dt>
        <dd id="scintillation"></dd>
        <dt id='scintRatioLabel'>Ratio:</dt>
        <dd id="scintRatio"></dd>
        <dt id='scintDateLabel'>Date:</dt>
        <dd id="scintDate"></dd>
      </dl>
    </section>
    <section id="scintNoInfo" style="display: none;">
      <p style="font-style: italic; font-size: 1.5em;">Unable to find any scintillation data for this block</p>
    </section>
  </section>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>
    // color constants (in HEX)
    const red = '#800000'
    const orange = '#e66000'
    const green = '#008000'
    // store each section's ID in an array for easy iteration:
    const allSectionPrefixes = ['blockDetails', 'density', 'lightTrans', 'natLight', 'scint']
    // store each section's value IDs in an array for easy iteration:
    const blockDetailsKeys = ['dbn', 'block', 'status', 'shipment', 'sector', 'comment']
    const densityKeys = ['volume', 'mass', 'density', 'densityDate']
    const lightTransKeys = ['goodEnd', 'fiberPercentage', 'missingRow', 'thirteenHoles', 'lightTransDate']
    const natLightKeys = ['natLightDate']
    const scintKeys = ['scintillation', 'scintRatio', 'scintDate']
    // store all image prefixes in an array for easy iteration
    const allImagePrefixes = ['lightTransImg', 'lightTransImgCropped', 'natLightImg']
    // store all testing image IDs in an array for easy iteration:
    const allTestingImgs = ['lightTransImgW', 'lightTransImgN', 'lightTransImgCroppedW', 'lightTransImgCroppedN', 'natLightImgW', 'natLightImgN']
    // IF a testing value has a key in this map, display the message when no data for that value was found
    // otherwise, hide the value and it's name by default
    const failureMessages = new Map()
    // IF a testing value has a key in this map and the block has this data, append this suffix (after a space) to the data
    // note that since status is block-specific, it is handled separately by updateField
    const suffixes = new Map([
      ['volume', 'mL'],
      ['mass', 'g'],
      ['density', 'g/mL'],
      ['fiberPercentage', '%'],
      ['scintillation', 'mV']
    ])
    // converts a status number to english so it can be added to the block information (the suffix that appears after the status number)
    const statusMap = new Map([
      ['0','(fiber set)'],
      ['1','(fibers in mold)'],
      ['2','(tungsten in mold)'],
      ['3','(potted)'],
      ['4','(machining)'],
      ['5','(ready for testing)'],
      ['5a','(A-grade, all tests good)'],
      ['5b','(B-grade, some tests bad)'],
      ['6','(ready to be shipped)'],
      ['7','(shipped, at BNL)'],
      ['8','(graveyard)']
    ])
    // maximum DBN (reject dbns larger than this)
    var maxDbn = 3498
    // For sheet Blocks DB
    const blocksSheet1Map = ([
      ['dbn', 0],
      ['block', 2],
      ['status', 3],
      ['shipment', 4],
      ['comment', 6],
      ['sector', 7],
      ['powder', 14],
      ['bucket', 15],
      ['moldSeries', 16],
      ['emptyMoldMass', 17],
      ['filledMoldMass', 18],
      ['tungstenMass', 19],
      ['tungstenFillingDate', 21],
      ['epoxyBatch', 23],
      ['resinMass', 24],
      ['hardenerMass', 25],
      ['pottingNotes', 26],
      ['epoxyFillingTime', 27],
      ['epoxyFillingDate', 28],
      ['volume', 40],
      ['mass', 42],
      ['density', 44],
      ['densityDate', 45],
      ['goodEnd', 47],
      ['fiberPercentage', 49],
      ['tower1', 55],
      ['tower2', 56],
      ['tower3', 57],
      ['tower4', 58],
      ['missingRow', 59],
      ['thirteenHoles', 60],
      ['lightTransDate', 64],
      ['scintillation', 65],
      ['scintRatio', 67],
      ['scintDate', 69],
      ['natLightDate', 70]
    ])
    // For sheet Blocks1364DB
    const blocksSheet2Map = ([
      ['dbn', 0],
      ['block', 2],
      ['status', 3],
      ['shipment', 4],
      ['sector', 6],
      ['comment', 7],
      ['powder', 14],
      ['bucket', 15],
      ['moldSeries', 16],
      ['emptyMoldMass', 17],
      ['filledMoldMass', 18],
      ['tungstenMass', 19],
      ['tungstenFillingDate', 21],
      ['epoxyBatch', 23],
      ['resinMass', 24],
      ['hardenerMass', 25],
      ['pottingNotes', 26],
      ['epoxyFillingTime', 27],
      ['epoxyFillingDate', 28],
      ['volume', 40],
      ['mass', 42],
      ['density', 44],
      ['densityDate', 45],
      ['goodEnd', 47],
      ['fiberPercentage', 49],
      ['tower1', 55],
      ['tower2', 56],
      ['tower3', 57],
      ['tower4', 58],
      ['missingRow', 59],
      ['thirteenHoles', 60],
      ['lightTransDate', 64],
      ['scintillation', 65],
      ['scintRatio', 67],
      ['scintDate', 69],
      ['natLightDate', 70]
    ])
    // array [Blocks DB, Blocks1364DB], where each element is a (large) 2D array
    var database
    // stores the expected dimensions for each block type
    const dimensionsMap = new Map([
    ['123', [5.5000,	2.0850,	2.0850,	1.9890,	1.8150,	1.8150,	1.9890]],
    ['4', [5.4460,	2.0850,	2.0820,	2.2740,	1.8180,	1.8150,	1.9900]],
    ['5', [5.3500,	2.0850,	2.0760,	2.2630,	1.8230,	1.8150,	1.9900]],
    ['6', [5.2700,	2.0850,	2.0710,	2.2530,	1.8280,	1.8150,	1.9900]],
    ['7', [5.2050,	2.0850,	2.0650,	2.2430,	1.8320,	1.8150,	1.9900]],
    ['8', [5.1550,	2.0850,	2.0600,	2.2340,	1.8370,	1.8150,	1.9890]],
    ['9', [5.1180,	2.0850,	2.0560,	2.2250,	1.8410,	1.8150,	1.9890]],
    ['10', [5.0940,	2.0850,	2.0510,	2.2160,	1.8460,	1.8150,	1.9890]],
    ['11', [5.0820,	2.0850,	2.0470,	2.2080,	1.8500,	1.8150,	1.9890]],
    ['12', [5.0810,	2.0850,	2.0420,	2.2010,	1.8530,	1.8150,	1.9890]],
    ['13', [5.0900,	2.0850,	2.0390,	2.1930,	1.8570,	1.8150,	1.9890]],
    ['14', [5.1100,	2.0850,	2.0350,	2.1860,	1.8600,	1.8150,	1.9890]],
    ['15', [5.1390,	2.0850,	2.0320,	2.1800,	1.8640,	1.8150,	1.9890]],
    ['16', [5.1770,	2.0850,	2.0280,	2.1740,	1.8670,	1.8150,	1.9890]],
    ['17', [5.2240,	2.0850,	2.0250,	2.1680,	1.8700,	1.8150,	1.9890]],
    ['18', [5.2790,	2.0850,	2.0230,	2.1620,	1.8720,	1.8150,	1.9890]],
    ['19', [5.3420,	2.0850,	2.0200,	2.1570,	1.8750,	1.8150,	1.9890]],
    ['20', [5.4120,	2.0850,	2.0180,	2.1520,	1.8770,	1.8150,	1.9890]],
    ['21', [5.4890,	2.0850,	2.0150,	2.1470,	1.8790,	1.8150,	1.9890]],
    ['22', [5.5720,	2.0850,	2.0130,	2.1420,	1.8810,	1.8150,	1.9890]],
    ['23', [5.6620,	2.0850,	2.0120,	2.1380,	1.8830,	1.8150,	1.9890]],
    ['24', [5.7580,	2.0850,	2.0100,	2.1330,	1.8850,	1.8150,	1.9890]]
    ])
    // changes to true when the "do not press" button is pressed, which changes the way image urls are obtained
    var slowMode = false
    // called when the web page is loaded—loads the database
    function getDatabaseOnLoad() {
      document.getElementById('loadingDatabase').style.display = 'block'
      google.script.run.withSuccessHandler(onSuccess).getDatabase()
      function onSuccess (gotDatabase) {
        if (gotDatabase == null) {
          alert('oops, fn gotDatabase returned null! unable to load database and testing folders from drive')
          document.getElementById('loadingDatabase').style.display = 'none'
          return
        } else if (gotDatabase[2] !== '') {
          // an error occured, so display an alert with the error message passed from script
          alert('an error occured while loading the database and testing fodlers: ' + gotDatabase[2])
          document.getElementById('loadingDatabase').style.display = 'none'
        } else {
          console.log('loaded database and testing folders without error')
          database = gotDatabase
          document.getElementById('loadingDatabase').style.display = 'none'
          document.getElementById('notHeader').style.display = 'block'
        }
      }
    }
    
    // called when enter is pressed in text box or submit button is clicked
    function onSubmit() {
      // load the database if it hasn't been loaded
      if (database == null) {
        getDatabaseOnLoad()
        afterOnSubmit()
      } else {
        afterOnSubmit()
      }
      function afterOnSubmit () {
        // create a timestamp to display     
        document.getElementById("currentDateAndTime").innerHTML = 'As of: ' + Date(Date.now()).toString()
        document.getElementById("currentDateAndTime").style.display = 'block'
        // show that we're loading the block data
        document.getElementById("loadingBlockData").style.display = 'block'
        // grab the dbn from the input box
        var dbn = document.getElementById("inputDBN").value
        console.log('fetching information for DBN ' + dbn)
        // hide all block info and noInfo sections for them to be loaded if needed by loadTestingData
        for (let i = 0; i < allSectionPrefixes.length; i++) {
          document.getElementById(allSectionPrefixes[i] + 'Section').style.display = 'none'
          document.getElementById(allSectionPrefixes[i] + 'NoInfo').style.display = 'none'
        }
        // hide imagesSelection section for it to be loaded if needed by loadTestingData
        document.getElementById("imagesSelection").style.display = 'none'
        // and reset the checkboxes
        resetCheckboxes()
        // and reset text that isn't automatically reset in imagesSelection section
        document.getElementById("noImagesFound").style.display = 'none'
        // and reset the img src urls just in case one happens to be shown but on overwritten
        // (e.g. one LT cropped image returns a url and the other does not (e.g. DBN 78))
        for (let i = 0; i < allTestingImgs.length; i++) {
          document.getElementById(allTestingImgs[i]).src = '#'
        }
        // run loadTestingDataAsStringifiedJson and pass it's return data to a success handler
        console.log('loading testing data')
        loadTestingData(dbn)
      }
    }
    // takes array of string element ids and clears their innerHTML
    function clearElements(array) {
      for (let i = 0; i < array.length; i++) {
        document.getElementById(array[i]).innerHTML = ''
      }
    }
    // pulls the info with key id from blockDataMap and updates its innerHTML if it contains info
    // adds a suffix if one exists in suffixes (Map), and adds status suffix if the key is 'status'
    // (status is handle differently since it can't be integrated into status map since it's block-specific)
    // hides the element AND its label if failureMessages does not have the key
    // otherwise sets the innerHTML to the key's failure message
    function updateField(blockDataMap, id) {
      if (dataPresent(blockDataMap.get(id))) {
        document.getElementById(id).innerHTML = blockDataMap.get(id)
        if (suffixes.has(id) || id === 'status') {
          if (id === 'status') {
            document.getElementById(id).innerHTML += ' ' + statusMap.get(blockDataMap.get('status'))
          } else {
            document.getElementById(id).innerHTML += ' ' + suffixes.get(id)
          }
        }
        document.getElementById(id).style.display = 'inline'
        document.getElementById(id + 'Label').style.display = 'inline'
      } else {
        if (failureMessages.has(id)) {
          document.getElementById(id).innerHTML = failureMessages.get(id)
        } else {
          document.getElementById(id).style.display = 'none'
          document.getElementById(id + 'Label').style.display = 'none'
        }
      }
    }
    // Checks if a value (say, returned by a map) is significant (not null, empty, #NUM!, or #DIV/0!)
    function dataPresent (data) {
      return (data != null && data != '' && data != '#NUM!' && data != '#DIV/0!')
    }
    // takes a map and an array of string ids and checks if any map values for key ids have data
    // "has data" is determined by function dataPresent
    function someDataPresent(map, array) {
      return array.some(function(element) {
        return dataPresent(map.get(element))
      })
    }
    // loads testing data, updates fields, and unhides relevant sections based on the data present
    function loadTestingData (dbn) {
      let blockMap = new Map()
      // The dbn passed from the html doesn't seem to be an int, so make sure it is (dbn 1 would return info for dbn 10 otherwise)
      dbn = Math.floor(dbn)
      // Reject invalid dbns and choose the correct sheet and map for valid dbns
      if (isNaN(dbn) || dbn < 0 || dbn > maxDbn) {
        alert('that dbn was invalid or out of range')
        document.getElementById("loadingBlockData").style.display = 'none'
        document.getElementById("currentDateAndTime").style.display = 'none'
      } else if (dbn < 2000) {
        var currentSheet = database[0]
        var currentRowOffset = 1
        var currentSheetMap = blocksSheet1Map
      } else {
        var currentSheet = database[1]
        var currentRowOffset = 1 - 2000
        var currentSheetMap = blocksSheet2Map
      }
      // dbn is good, so pull data from the database
      let row = dbn + currentRowOffset
      // Construct a cell range in A1 format for the block's row
      let blockData = currentSheet[row]
      // grab each dimension measurement in an array
      let dimensions = blockData.slice(33, 40)
      // Create a new map that maps block properites to their actual values
      for (let pair of currentSheetMap) {
        // Logger.log("currentSheetMap has key " + pair[0] + " -> " + blockData[pair[1]]);
        blockMap.set(pair[0], blockData[pair[1]])
      }
      // first check for ALL nulls, in which case there's no information for this dbn
      let blockMapArray = Array.from(blockMap)
      let allNull = blockMapArray.every(function(element) {
        return element == null || !dataPresent(element[1])
      })
      if (allNull) {
        // no data at all for this dbn
        document.getElementById("loadingBlockData").style.display = 'none'
        alert('no information at all was found for this DBN')
        document.getElementById("currentDateAndTime").style.display = 'none'
        return
      }
      let getImageUrlsRun = false
      let toGetImageUrls = [blockMap.get('dbn'), blockMap.get('lightTransDate'), blockMap.get('natLightDate')]

      // BLOCK DETAILS  (check if data is present)
      const tungstenTableEntries = ['powder', 'bucket', 'moldSeries', 'emptyMoldMass', 'filledMoldMass', 'tungstenMass', 'tungstenFillingDate']
      const epoxyTableEntries = ['epoxyBatch', 'resinMass', 'hardenerMass', 'pottingNotes', 'epoxyFillingTime', 'epoxyFillingDate']
      if (someDataPresent(blockMap, blockDetailsKeys)) {
        // some block info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("blockDetailsSection").style.display = 'block'
        for (let i = 0; i < blockDetailsKeys.length; i++) {
          updateField(blockMap, blockDetailsKeys[i])
        }
        let hasTungstenData = tungstenTableEntries.some(function(element) {
          return dataPresent(blockMap.get(element)) && element !== 'tungstenMass'
        })
        if (hasTungstenData) {
          for (let i = 0; i < tungstenTableEntries.length; i++) {
            let entry = tungstenTableEntries[i]
            document.getElementById(entry).innerHTML = blockMap.get(entry)
          }
          document.getElementById('showTungstenTableBtn').style.display = 'block'
        } else {
          document.getElementById('showTungstenTableBtn').style.display = 'none'
          document.getElementById('tungstenTable').style.display = 'none'
        }
        if (someDataPresent(blockMap, epoxyTableEntries)) {
          for (let i = 0; i < epoxyTableEntries.length; i++) {
            let entry = epoxyTableEntries[i]
            document.getElementById(entry).innerHTML = blockMap.get(entry)
          }
          document.getElementById('showEpoxyTableBtn').style.display = 'block'
        } else {
          document.getElementById('showEpoxyTableBtn').style.display = 'none'
          document.getElementById('epoxyTable').style.display = 'none'
        }
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < blockDetailsKeys.length; i++) {
          document.getElementById(blockDetailsKeys[i]).innerHTML = ''
        }
        document.getElementById("blockDetailsNoInfo").style.display = 'block'
      }
      
      // DENSITY  (check if data is present)
      if (someDataPresent(blockMap, densityKeys)) {
        // some block info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("densitySection").style.display = 'block'
        for (let i = 0; i < densityKeys.length; i++) {
          updateField(blockMap, densityKeys[i])
        }
        let hasDimensionInfo = false
        for (let i = 0; i < dimensions.length; i++) {
          if (dataPresent(dimensions[i])) {
            hasDimensionInfo = true
            break
          }
        }
        if (hasDimensionInfo) {
          let block = blockMap.get('block')
          const tolerancesTableEntries = ['L', 'BT', 'BB', 'BH', 'ST', 'SB', 'SH']
          document.getElementById('inSpec').innerHTML = inSpec(block, dimensions)
          for (let i = 0; i < dimensions.length; i++) {
            if (dimensions[i] - dimensionsMap.get(block)[i] <= 0) {
              document.getElementById(tolerancesTableEntries[i]).innerHTML = (dimensions[i] - dimensionsMap.get(block)[i]).toFixed(4)
            } else {
              document.getElementById(tolerancesTableEntries[i]).innerHTML = '+' + (dimensions[i] - dimensionsMap.get(block)[i]).toFixed(4)
            }
            if (dimensions[i] - dimensionsMap.get(block)[i] > 0.02) {
              document.getElementById(tolerancesTableEntries[i]).style.color = red
            } else if (dimensions[i] - dimensionsMap.get(block)[i] < -0.02) { 
              document.getElementById(tolerancesTableEntries[i]).style.color = orange
            } else {
              document.getElementById(tolerancesTableEntries[i]).style.color = green
            }
          }
          document.getElementById('inSpec').style.display = 'inline'
          document.getElementById('inSpecLabel').style.display = 'inline'
          document.getElementById('showTolerancesTableBtn').style.display = 'inline'
        } else {
          document.getElementById('inSpec').style.display = 'none'
          document.getElementById('inSpecLabel').style.display = 'none'
          document.getElementById('showTolerancesTableBtn').style.display = 'none'
          document.getElementById('tolerancesTable').style.display = 'none'
        } 
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < densityKeys.length; i++) {
          document.getElementById(densityKeys[i]).innerHTML = ''
        }
        document.getElementById("densityNoInfo").style.display = 'block'
      }

      // LIGHT TRANSMISSION (check if data is present)
      let hasLightTransData = lightTransKeys.some(function(element) {
        return dataPresent(blockMap.get(element)) && element !== 'fiberPercentage'
      })
      if (hasLightTransData) {
        // some block info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("lightTransSection").style.display = 'block'
        for (let i = 0; i < lightTransKeys.length; i++) {
          updateField(blockMap, lightTransKeys[i])
        }
        // and run getImageUrls
        document.getElementById("imagesSelection").style.display = 'block'
        document.getElementById("loadingImages").style.display = 'block'
        console.log('fetching image urls')
        if (slowMode) {
          getImageUrlsSlow(toGetImageUrls[0])
        } else {
          google.script.run.withSuccessHandler(onGetImageUrlsSuccess).getImageUrls(toGetImageUrls)
        }
        getImageUrlsRun = true
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < lightTransKeys.length; i++) {
          document.getElementById(lightTransKeys[i]).innerHTML = ''
        }
        document.getElementById("lightTransNoInfo").style.display = 'block'
      }
      
      // NATURAL LIGHT (check if data is present)
      if (someDataPresent(blockMap, natLightKeys)) {
        // some info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("natLightSection").style.display = 'block'
        for (let i = 0; i < natLightKeys.length; i++) {
          updateField(blockMap, natLightKeys[i])
        }
        const towerTableEntries = ['tower1', 'tower2', 'tower3', 'tower4']
        if (someDataPresent(blockMap, towerTableEntries)) {
          for (let i = 0; i < towerTableEntries.length; i++) {
            let entry = towerTableEntries[i]
            document.getElementById(entry).innerHTML = blockMap.get(entry)
          }
          document.getElementById('showTowerTableBtn').style.display = 'inline'
        } else {
          document.getElementById('showTowerTableBtn').style.display = 'inline'
          document.getElementById('towerTable').style.display = 'inline'
        }
        // run getImageUrls if it hasn't been run by light transmission
        if (!getImageUrlsRun) {
          // run getImageUrls if it hasn't been run
          document.getElementById("imagesSelection").style.display = 'block'
          document.getElementById("loadingImages").style.display = 'block'
          console.log('fetching image urls')
          if (slowMode) {
            getImageUrlsSlow(toGetImageUrls[0])
          } else {
            google.script.run.withSuccessHandler(onGetImageUrlsSuccess).getImageUrls(toGetImageUrls)
          }
          getImageUrlsRun = true
        }
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < natLightKeys.length; i++) {
          document.getElementById(natLightKeys[i]).innerHTML = ''
        }
        document.getElementById("natLightNoInfo").style.display = 'block'
        // I don't need to run getImageUrls, so if light transmission didn't run it, then we don't need any of the image checkboxes
        // AND we need to reset them (if they are checked, uncheck them and toggle)
        if (!getImageUrlsRun) {
          console.log('determined there was no need to search for images')
          resetCheckboxes();
        }
      }
      
      // SCINTILLATION (check if data is present)
      if (someDataPresent(blockMap, scintKeys)) {
        // some info present, so make the info section visible and update its entries and hide the noInfo section
        document.getElementById("scintSection").style.display = 'block'
        for (let i = 0; i < scintKeys.length; i++) {
          updateField(blockMap, scintKeys[i])
        }
      } else {
        // no block info present, so make the noInfo section visible and clear entries in info section
        for (let i = 0; i < scintKeys.length; i++) {
          document.getElementById(scintKeys[i]).innerHTML = ''
        }
        document.getElementById("scintNoInfo").style.display = 'block'
      }
      
      // now hide the loading block data text...
      document.getElementById("loadingBlockData").style.display = 'none'
    }

    // resets a checkbox to unchecked
    function resetCheckbox (imagePrefix) {
      // if a checkbox is checked, uncheck it and call it's toggle function to hide images
      if (document.getElementById('CBshow-' + imagePrefix).checked == true) {
        document.getElementById('CBshow-' + imagePrefix).checked = false
        toggleImages(imagePrefix)
      }
      // then hide the checkbox
      document.getElementById('CBshow-' + imagePrefix + 'Section').style.display = 'none'
    }

    // reset all checkboxes individually and hide checkboxes section
    function resetCheckboxes () {
      for (let i = 0; i < allImagePrefixes.length; i++) {
        resetCheckbox(allImagePrefixes[i])
      }
      document.getElementById("allCheckboxes").style.display = 'none'
    }

    // does not perfectly nicely handle the situation where ONE end's image is present and the other is not..
    // since this case is so rare, it tries to load both (and if one happens to not have an image, a placeholder is displayed)
    function onGetImageUrlsSuccess (imageUrls) {
      // check if getImageUrls returned any urls...
      if (imageUrls.every((element) => element == null)) {
        // ...NO image urls were returned, so there's no image data to display
        document.getElementById("loadingImages").style.display = 'none'
        document.getElementById("noImagesFound").style.display = 'block'
        return
      }
      // first set all not null urls to their image srcs
      imageUrls.forEach((element, index) => {
        if (element != null) {
          document.getElementById(allTestingImgs[index]).src = element
        }
      });
      // determine which checkboxes / image sections need to be displayed
      for (let i = 0; i < allImagePrefixes.length; i++) {
        if (imageUrls[2*i] != null || imageUrls[2*i + 1] != null) {
          // one of this section's images is present, so display its checkbox
          document.getElementById('CBshow-' + allImagePrefixes[i] + 'Section').style.display = 'block'
        } else {
          // this section is not needed—reset its checkbox
          resetCheckbox(allImagePrefixes[i])
        }
      }
      // finally, display the checkboxes section
      document.getElementById("loadingImages").style.display = 'none'
      document.getElementById("allCheckboxes").style.display = 'block'
    }

    function getImageUrlsSlow (dbn) {
      // check if getImageUrls returned any urls...
      if (bigArray[dbn] == null) {
        console.log('bigArray was null at index: ' + dbn)
        document.getElementById("loadingImages").style.display = 'none'
        document.getElementById("noImagesFound").style.display = 'block'
      } else {
        imageUrls = bigArray[dbn]
        if (imageUrls.every((element) => element == null)) {
          // ...NO image urls were returned, so there's no image data to display
          document.getElementById("loadingImages").style.display = 'none'
          document.getElementById("noImagesFound").style.display = 'block'
          return
        }
        // first set all not null urls to their image srcs
        imageUrls.forEach((element, index) => {
          if (element != null) {
            document.getElementById(allTestingImgs[index]).src = element[0]
          }
        });
        // determine which checkboxes / image sections need to be displayed
        for (let i = 0; i < allImagePrefixes.length; i++) {
          if (imageUrls[2*i] != null || imageUrls[2*i + 1] != null) {
            // one of this section's images is present, so display its checkbox
            document.getElementById('CBshow-' + allImagePrefixes[i] + 'Section').style.display = 'block'
          } else {
            // this section is not needed—reset its checkbox
            resetCheckbox(allImagePrefixes[i])
          }
        }
        // add suffixes to figure captions on NL images (left or right) if needed
        let imageUrlsIndexToEnd = new Map([[4, 'Wide End'], [5, 'Narrow End']])
        let positionCodeToPosition = new Map([[1, '(pictured on left)'], [2, '(pictured on right)']])
        for (let i = 4; i < imageUrls.length; i++) {
          if (imageUrls[i] != null) {
            if (imageUrls[i][2] != 0) {
              document.getElementById('natLightImgFigCaption' + i).innerHTML = imageUrlsIndexToEnd.get(i) + ' ' + positionCodeToPosition.get(imageUrls[i][2])
            } else {
              document.getElementById('natLightImgFigCaption' + i). innerHTML = imageUrlsIndexToEnd.get(i)
            }
          }
        }
        // finally, display the checkboxes section
        document.getElementById("loadingImages").style.display = 'none'
        document.getElementById("allCheckboxes").style.display = 'block'
      }
    }

    // takes an image name prefix (e.g. lightTransImg, lightTransImgCropped, or natLightImg)
    // and toggles the visibility of the corresponding wide and narrow images
    function toggleImages(imagePrefix) {
      let fig1 = document.getElementById(imagePrefix + 'FigW')
      let fig2 = document.getElementById(imagePrefix + 'FigN')
      if (fig1.style.display === "none" || fig2.style.display === "none") {
        fig1.style.display = "block"
        fig2.style.display = "block"
      } else {
        fig1.style.display = "none"
        fig2.style.display = "none"
      }
    }
    // changes the way image urls are obtained
    function madness () {
      alert('loading ALL image urls, do not submit another dbn before this request completes (should take about 90 seconds)')
      slowMode = true
      google.script.run.withSuccessHandler(onSuccess).loadBigArray()
      function onSuccess (data) {
        if (data == null) {
          console.log('bigArray was null :(')
          alert('there was an error fetching ALL image urls')
        } else {
          bigArray = data
          console.log('loaded bigArray')
          alert('loaded ALL image urls')
        }
      }
    }
    // determines if ALL of a block's dimensions are in spec (within 0.02 inch of expected)
    function inSpec (blockDesign, dimensions) {
      for (let i = 0; i < dimensions.length; i++) {
        if (Math.abs(dimensions[i] - dimensionsMap.get(blockDesign)[i]) > 0.02) {
          return 'No'
        }
      }
      return 'Yes'
    }
    // hides/shows the tungsten table
    function toggleTungstenTable () {
      if (document.getElementById('tungstenTable').style.display === 'none') {
        document.getElementById('tungstenTable').style.display = 'block'
        document.getElementById('showTungstenTableBtn').innerHTML = 'Hide Tungsten Powder Infomation'
      } else {
        document.getElementById('tungstenTable').style.display = 'none'
        document.getElementById('showTungstenTableBtn').innerHTML = 'Show Tungsten Powder Information'
      }
    }
    // hides/shows the epoxy table
    function toggleEpoxyTable () {
      if (document.getElementById('epoxyTable').style.display === 'none') {
        document.getElementById('epoxyTable').style.display = 'block'
        document.getElementById('showEpoxyTableBtn').innerHTML = 'Hide Epoxy Information'
      } else {
        document.getElementById('epoxyTable').style.display = 'none'
        document.getElementById('showEpoxyTableBtn').innerHTML = 'Show Epoxy Information'
      }
    }
    // hides/shows the tolerances table
    function toggleTolerancesTable () {
      if (document.getElementById('tolerancesTable').style.display === 'none') {
        document.getElementById('tolerancesTable').style.display = 'block'
        document.getElementById('showTolerancesTableBtn').innerHTML = 'Hide Tolerances'
      } else {
        document.getElementById('tolerancesTable').style.display = 'none'
        document.getElementById('showTolerancesTableBtn').innerHTML = 'Show Tolerances'
      }
    }
    // hides/shows the tower table
    function toggleTowerTable () {
      if (document.getElementById('towerTable').style.display === 'none') {
        document.getElementById('towerTable').style.display = 'block'
        document.getElementById('showTowerTableBtn').innerHTML = 'Hide Tower Information'
      } else {
        document.getElementById('towerTable').style.display = 'none'
        document.getElementById('showTowerTableBtn').innerHTML = 'Show Tower Information'
      }
    }
  </script>
</body>
</html>